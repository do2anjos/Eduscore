<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cadastro de Usuário</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <script src="utils.js" defer></script>
</head>
<body>
  <div class="container">
    <div class="left">
      <div style="background-color: white; border-radius: 12px; padding: 40px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <label for="uploadFoto" style="cursor: pointer; position: relative;">
          <img id="previewImagem" src="https://img.icons8.com/ios/150/000000/user-male-circle.png" alt="Foto de Perfil" style="width: 150px; height: 150px; margin-bottom: 15px; object-fit: cover; border-radius: 50%;" />
          <div style="position: absolute; bottom: 20px; right: 0; background: #4CAF50; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 16px;">+</span>
          </div>
        </label>
        
        <input type="file" id="uploadFoto" accept="image/*" style="display: none;" onchange="previewImagemPerfil(event)" />
        <input type="hidden" id="fotoBase64" name="fotoBase64" />
        
        <p style="color: #555; font-size: 14px;">Clique na imagem para adicionar foto</p>
        
        <div id="successMessage" class="success-message"></div>
        <div id="errorMessage" class="error-message" style="margin-top: 10px;"></div>
      </div>
    </div>

    <div class="right">
      <form id="formCadastro" class="form-box" onsubmit="cadastrarUsuario(event)">
        <h2>Cadastro de Usuário</h2>
        
        <div class="input-group">
          <label class="required-field">Nome completo</label>
          <input type="text" id="nome" name="nome" placeholder="Digite seu nome completo" required />
        </div>
        
        <div class="input-group">
          <label class="required-field">Email institucional</label>
          <input type="email" id="email" name="email" placeholder="exemplo@instituicao.edu.br" required />
        </div>
        
        <div class="input-group">
          <label class="required-field">Matrícula</label>
          <input type="text" id="matricula" name="matricula" placeholder="Digite sua matrícula" required />
        </div>
        
        <div class="input-group">
          <label>Telefone</label>
          <input type="text" id="telefone" name="telefone" placeholder="(00) 00000-0000" oninput="formatarTelefone(this)" />
        </div>

        <div class="input-group">
          <label class="required-field">Perfil</label>
          <select id="perfil" name="perfil" required>
            <option value="">Selecione seu perfil</option>
            <option value="professor">Professor</option>
            <option value="coordenador">Coordenador</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        
        <div class="input-group">
          <label class="required-field">Senha</label>
          <input type="password" id="senha" name="senha" placeholder="Crie uma senha segura" required 
                 onkeyup="validarSenha()" onfocus="showPasswordRequirements()" onblur="hidePasswordRequirements()" />
          
          <div id="passwordRequirements" class="password-requirements" style="display: none;">
            <div class="requirement invalid" id="reqLength">
              <span class="icon">✘</span> Mínimo 8 caracteres
            </div>
            <div class="requirement invalid" id="reqUpper">
              <span class="icon">✘</span> Pelo menos 1 letra maiúscula (A-Z)
            </div>
            <div class="requirement invalid" id="reqLower">
              <span class="icon">✘</span> Pelo menos 1 letra minúscula (a-z)
            </div>
            <div class="requirement invalid" id="reqNumber">
              <span class="icon">✘</span> Pelo menos 1 número (0-9)
            </div>
            <div class="requirement invalid" id="reqSpecial">
              <span class="icon">✘</span> Pelo menos 1 símbolo (@$!%*?&)
            </div>
          </div>
          
          <div class="password-strength">
            <div id="passwordStrengthBar" class="password-strength-bar"></div>
          </div>
          <div id="senhaError" class="error-message"></div>
        </div>
        
        <div class="input-group">
          <label class="required-field">Confirmar Senha</label>
          <input type="password" id="confirmarSenha" name="confirmarSenha" placeholder="Repita a senha" required 
                 onkeyup="validarConfirmacaoSenha()" />
          <div id="confirmarSenhaError" class="error-message">As senhas não coincidem</div>
        </div>
        
        <div class="input-group" style="margin-top: 20px;">
          <button type="submit" class="email-btn" id="submitBtn">
            <span id="btnText">Cadastrar Usuário</span>
            <span id="btnSpinner" class="loading-spinner"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function previewImagemPerfil(event) {
      const input = event.target;
      const imagemPreview = document.getElementById('previewImagem');
      const fotoBase64Input = document.getElementById('fotoBase64');

      if (input.files && input.files[0]) {
        if (input.files[0].size > 5 * 1024 * 1024) {
          showErrorMessage('A imagem é muito grande. Por favor, selecione uma imagem menor que 5MB.');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          imagemPreview.src = e.target.result;
          fotoBase64Input.value = e.target.result.split(',')[1];
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function showPasswordRequirements() {
      document.getElementById('passwordRequirements').style.display = 'block';
      validarSenha();
    }

    function hidePasswordRequirements() {
      document.getElementById('passwordRequirements').style.display = 'none';
    }

    function updateRequirement(elementId, isValid) {
      const element = document.getElementById(elementId);
      element.classList.toggle('valid', isValid);
      element.classList.toggle('invalid', !isValid);
      element.querySelector('.icon').textContent = isValid ? '✓' : '✘';
    }

    function validarSenha() {
      const senha = document.getElementById('senha').value;
      const strengthBar = document.getElementById('passwordStrengthBar');
      const errorElement = document.getElementById('senhaError');
      
      const hasLength = senha.length >= 8;
      const hasUpper = /[A-Z]/.test(senha);
      const hasLower = /[a-z]/.test(senha);
      const hasNumber = /\d/.test(senha);
      const hasSpecial = /[#@$!%*?&]/.test(senha);
      
      updateRequirement('reqLength', hasLength);
      updateRequirement('reqUpper', hasUpper);
      updateRequirement('reqLower', hasLower);
      updateRequirement('reqNumber', hasNumber);
      updateRequirement('reqSpecial', hasSpecial);
      
      const senhaValida = hasLength && hasUpper && hasLower && hasNumber && hasSpecial;
      
      if (senhaValida) {
        strengthBar.style.width = '100%';
        strengthBar.style.backgroundColor = '#4CAF50';
        errorElement.style.display = 'none';
        return true;
      } else {
        strengthBar.style.width = '30%';
        strengthBar.style.backgroundColor = '#ff0000';
        errorElement.textContent = 'A senha não atende a todos os requisitos';
        errorElement.style.display = 'block';
        return false;
      }
    }

    function validarConfirmacaoSenha() {
      const senha = document.getElementById('senha').value;
      const confirmarSenha = document.getElementById('confirmarSenha').value;
      const errorElement = document.getElementById('confirmarSenhaError');
      
      if (confirmarSenha.length === 0) {
        errorElement.style.display = 'none';
        return true;
      }
      
      if (senha !== confirmarSenha) {
        errorElement.style.display = 'block';
        return false;
      } else {
        errorElement.style.display = 'none';
        return true;
      }
    }

    function formatarTelefone(input) {
      let value = input.value.replace(/\D/g, '');
      
      if (value.length > 11) {
        value = value.substring(0, 11);
      }
      
      if (value.length > 2) {
        value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
      }
      
      if (value.length > 10) {
        value = `${value.substring(0, 10)}-${value.substring(10)}`;
      }
      
      input.value = value;
    }

    function showLoading() {
      document.getElementById('btnText').style.display = 'none';
      document.getElementById('btnSpinner').style.display = 'inline-block';
      document.getElementById('submitBtn').disabled = true;
    }

    function hideLoading() {
      document.getElementById('btnText').style.display = 'inline';
      document.getElementById('btnSpinner').style.display = 'none';
      document.getElementById('submitBtn').disabled = false;
    }

    function showSuccessMessage(message) {
      const element = document.getElementById('successMessage');
      element.textContent = message;
      element.style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';
    }

    function showErrorMessage(message) {
      const element = document.getElementById('errorMessage');
      element.textContent = message;
      element.style.display = 'block';
      document.getElementById('successMessage').style.display = 'none';
    }

    async function cadastrarUsuario(event) {
      event.preventDefault();
      
      const senhaValida = validarSenha();
      const confirmacaoValida = validarConfirmacaoSenha();
      
      if (!senhaValida || !confirmacaoValida) {
        showErrorMessage('Por favor, corrija os erros no formulário antes de enviar.');
        return;
      }
      
      const formData = {
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        matricula: document.getElementById('matricula').value,
        telefone: document.getElementById('telefone').value.replace(/\D/g, ''),
        foto_perfil: document.getElementById('fotoBase64').value,
        senha: document.getElementById('senha').value,
        perfil: document.getElementById('perfil').value
      };
      
      try {
        showLoading();
        showErrorMessage('');
        
        const response = await fetch('http://localhost:3000/api/usuarios/registro', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.erro?.message || data.erro || 'Erro desconhecido');
        }
        
        // Heurística 1: Feedback visual
        showToast('Usuário cadastrado com sucesso! Redirecionando...', 'success');
        
        document.getElementById('formCadastro').reset();
        document.getElementById('previewImagem').src = 'https://img.icons8.com/ios/150/000000/user-male-circle.png';
        document.getElementById('fotoBase64').value = '';
        document.getElementById('passwordStrengthBar').style.width = '0%';
        
        setTimeout(() => {
          window.location.href = '/login.html';
        }, 2000);
      } catch (error) {
        console.error('Erro ao cadastrar usuário:', error);
        // Heurística 9: Mensagens de erro claras
        showToast(`Erro no cadastro: ${error.message}`, 'error', 5000);
      } finally {
        hideLoading();
      }
    }
  </script>
</body>
</html>
