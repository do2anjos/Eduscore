<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Relat√≥rio Individual</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="utils.js" defer></script>
</head>
<body>
<div class="home-container">
  <aside class="sidebar">
    <div class="profile">
      <img src="https://img.icons8.com/ios-filled/100/ffffff/user-male-circle.png" alt="Perfil"/>
       <span>
          Coordenador<br>
          <small>coordenacao@uea.edu.br</small>
        </span>
    </div>
      <nav class="nav-links" role="navigation" aria-label="Menu principal">
        <a href="home.html">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/home-page.png" alt="" /> Home
        </a>
      <div class="dropdown">
          <a href="RelatorioGeral.html">
            <img src="https://img.icons8.com/ios-filled/24/ffffff/report-card.png" alt="" /> Gerar Relat√≥rio
        </a>
        <div class="dropdown-options">
          <a href="RelatorioGeral.html" class="sub">Relat√≥rio Geral</a>
          <a href="GerarRelatorio.html" class="sub active">Relat√≥rio Individual</a>
        </div>
      </div>
      <a href="Cadastrar.html">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/add-user-male.png" alt="" /> Cadastrar
      </a>
      <a href="CadastrarGabarito.html">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/test-passed.png" alt="" /> Simulado
      </a>
      <a href="AgendarSessao.html">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/calendar.png" alt="" /> Agendar Sess√£o
      </a>
    </nav>
  </aside>

    <main class="content">
      <!-- Breadcrumb e User Profile na mesma linha -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <nav class="breadcrumb" aria-label="Breadcrumb" style="margin: 0;">
          <a href="home.html">Home</a>
          <span class="breadcrumb-separator">/</span>
          <a href="RelatorioGeral.html">Relat√≥rios</a>
          <span class="breadcrumb-separator">/</span>
          <span>Relat√≥rio Individual</span>
        </nav>
        <div class="user-profile-menu">
          <button class="user-avatar-button" id="user-menu-button" aria-label="Abrir menu do usu√°rio">AS</button>
          <div class="dropdown-menu hidden" id="user-dropdown">
            <div class="dropdown-header">
              <p class="user-name">Anna Souza</p>
              <p class="user-email">anna.souza@uea.edu.br</p>
              <p class="user-score"><strong>Professor</strong></p>
            </div>
            <ul>
              <li><a href="meuperfil.html"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> Meu Perfil</a></li>
              <li><a href="configuracoes.html"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-4.44a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.88z"></path><path d="M18 2h-2.17a2 2 0 0 0-1.41.59L12 5l-2.41-2.41A2 2 0 0 0 8.17 2H6"></path><path d="M9.5 2a2.83 2.83 0 0 1 5 0"></path></svg> Configura√ß√µes</a></li>
              <li><a href="#" onclick="logout()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg> Sair</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="dashboard-header">
        <div>
          <h2>Relat√≥rio Individual</h2>
          <p class="dashboard-subtitle">Consulte o desempenho detalhado de um aluno espec√≠fico</p>
        </div>
      </div>

      <!-- Campo de Busca -->
      <div class="metric-card-modern" style="margin-bottom: 24px;">
        <div class="metric-card-header">
          <h3>Buscar Aluno</h3>
          <span class="metric-icon">üîç</span>
        </div>
        <div class="metric-card-content" style="padding: 20px;">
          <!-- Campo de Busca e Bot√£o na mesma linha -->
          <div class="input-group" style="margin-bottom: 12px; max-width: 100%;">
            <label for="buscaAluno" style="font-size: 14px; margin-bottom: 6px;">Nome ou Matr√≠cula do Aluno</label>
            <div style="display: flex; gap: 10px; align-items: flex-start;">
              <div style="position: relative; flex: 1; min-width: 0;">
                <input 
                  type="text" 
                  id="buscaAluno" 
                  placeholder="Digite o nome ou matr√≠cula do aluno"
                  autocomplete="off"
                  onkeyup="buscarAlunos(event)"
                  onfocus="if(this.value.length >= 2) buscarAlunos(event)"
                  style="width: 100%; padding: 10px 14px; border: 1px solid #d2d2d2; border-radius: 8px; font-size: 14px; outline: none; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);"
                />
                <div id="sugestoesAlunos" style="position: absolute; top: 100%; left: 0; right: 0; width: 100%; background: white; border: 1px solid #d2d2d2; border-radius: 8px; margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
              </div>
              <button 
                type="button" 
                class="email-btn" 
                onclick="buscarRelatorio()"
                id="btnBuscar"
                style="padding: 8px 16px; font-size: 13px; white-space: nowrap; margin-top: 0; height: fit-content; align-self: flex-end; min-width: 100px;"
              >
                <span id="btnBuscarText">Buscar</span>
                <span id="btnBuscarSpinner" class="loading-spinner" style="display: none;"></span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Informa√ß√µes do Aluno Selecionado (container din√¢mico ap√≥s buscar) -->
      <div id="infoAlunoSelecionado" class="metric-card-modern" style="display: none; padding: 12px 14px; background: linear-gradient(135deg, #f5f5f5 0%, #e8f4f8 100%); border-radius: 8px; border-left: 4px solid #008cc4; margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <div style="font-size: 20px; line-height: 1;">üë§</div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; color: #003b54; font-size: 14px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="nomeAlunoSelecionado"></div>
            <div style="color: #666; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Matr√≠cula: <span id="matriculaAlunoSelecionado" style="font-weight: 600; color: #008cc4;"></span></div>
            <div style="color: #666; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Ano/Etapa: <span id="etapaAlunoSelecionado" style="font-weight: 600; color: #008cc4;">N/A</span></div>
          </div>
        </div>
      </div>

      <!-- Cards de M√©tricas (ocultos inicialmente) -->
      <div id="containerMetricas" style="display: none;">
        <div class="metrics-grid">
          <div class="metric-card-modern">
            <div class="metric-card-header">
              <h3>Quest√µes Aplicadas</h3>
              <span class="metric-icon">üìä</span>
            </div>
            <div class="metric-card-content" style="justify-content: center; align-items: center; min-height: 120px;">
              <div class="metric-value">
                <span class="value-number" id="qtdQuestoes">0</span>
                <span class="value-label">quest√µes respondidas</span>
              </div>
            </div>
          </div>

          <div class="metric-card-modern">
            <div class="metric-card-header">
              <h3>Acertos</h3>
              <span class="metric-icon">‚úÖ</span>
            </div>
            <div class="metric-card-content" style="justify-content: center; align-items: center; min-height: 120px;">
              <div class="metric-value">
                <span class="value-number" id="acertosTotais">0</span>
                <span class="value-label">respostas corretas</span>
              </div>
        </div>
      </div>

          <div class="metric-card-modern">
            <div class="metric-card-header">
              <h3>Taxa de Acertos</h3>
              <span class="metric-icon">üìà</span>
            </div>
            <div class="metric-card-content" style="justify-content: center; align-items: center; min-height: 120px;">
              <div class="metric-value">
                <span class="value-number" id="taxaAcertos">0%</span>
                <span class="value-label">percentual de acertos</span>
              </div>
            </div>
          </div>

          <div class="metric-card-modern">
            <div class="metric-card-header">
              <h3>Maior M√©dia</h3>
              <span class="metric-icon">üèÜ</span>
            </div>
            <div class="metric-card-content" style="justify-content: center; align-items: center; min-height: 120px;">
              <div class="metric-value">
                <span class="value-number" id="maiorMediaDisciplina">-</span>
                <span class="value-label">disciplina com melhor desempenho</span>
              </div>
          </div>
          </div>

          <div class="metric-card-modern">
            <div class="metric-card-header">
              <h3>Menor M√©dia</h3>
              <span class="metric-icon">üìâ</span>
          </div>
            <div class="metric-card-content" style="justify-content: center; align-items: center; min-height: 120px;">
              <div class="metric-value">
                <span class="value-number" id="menorMediaDisciplina">-</span>
                <span class="value-label">disciplina que precisa de aten√ß√£o</span>
          </div>
          </div>
        </div>

          <div class="metric-card-modern">
            <div class="metric-card-header">
              <h3>Previs√£o</h3>
              <span class="metric-icon">üîÆ</span>
            </div>
            <div class="metric-card-content" style="justify-content: center; align-items: center; min-height: 120px;">
              <div class="metric-value">
                <span class="value-number" id="previsaoAcertos">N/A</span>
                <span class="value-label">N¬∞ acertos esperado no dia da prova</span>
              </div>
            </div>
          </div>
        </div>
      </div>

        <!-- Gr√°fico de Desempenho ao Longo do Tempo -->
        <div class="metric-card-modern full-width" style="margin-top: 24px;">
          <div class="metric-card-header">
          <h3>Desempenho ao Longo do Tempo</h3>
          </div>
          <div class="metric-card-content" style="min-height: 400px; padding: 20px;">
            <canvas id="graficoDesempenho"></canvas>
          </div>
        </div>

        <!-- Relat√≥rio Individual por Simulado -->
        <div id="containerRelatorioSimulados" class="metric-card-modern full-width" style="margin-top: 24px; display: none;">
          <div class="metric-card-header">
            <h3>Relat√≥rio Individual por Simulado</h3>
            <span class="metric-icon">üìã</span>
          </div>
          <div class="metric-card-content" style="padding: 20px;">
            <div id="tabelaSimulados" style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                  <tr style="background: linear-gradient(135deg, #008cc4 0%, #006a9a 100%); color: white; border-radius: 8px;">
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; border-radius: 8px 0 0 0;">Simulado</th>
                    <th style="padding: 12px 16px; text-align: center; font-weight: 600;">Etapa</th>
                    <th style="padding: 12px 16px; text-align: center; font-weight: 600;">Quest√µes</th>
                    <th style="padding: 12px 16px; text-align: center; font-weight: 600;">Acertos</th>
                    <th style="padding: 12px 16px; text-align: center; font-weight: 600;">M√©dia (%)</th>
                    <th style="padding: 12px 16px; text-align: center; font-weight: 600; border-radius: 0 8px 0 0;">Data</th>
                  </tr>
                </thead>
                <tbody id="corpoTabelaSimulados">
                  <!-- Dados ser√£o inseridos aqui dinamicamente -->
                </tbody>
              </table>
              <div id="mensagemSemSimulados" style="text-align: center; padding: 48px; color: #666; display: none;">
                <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                <p>Nenhum simulado encontrado para este aluno.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Desempenho por Disciplina -->
        <div class="metric-card-modern full-width" style="margin-top: 24px;">
          <div class="metric-card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Desempenho por Disciplina</h3>
            <div style="display: flex; align-items: center; gap: 10px;">
              <label for="filtroSimulado" style="font-size: 14px; color: #003b54; font-weight: 600;">Filtrar por:</label>
              <select 
                id="filtroSimulado" 
                onchange="filtrarDisciplinasPorSimulado(event)"
                style="padding: 8px 12px; border: 1px solid #d2d2d2; border-radius: 8px; font-size: 14px; outline: none; cursor: pointer; background: white; color: #003b54; min-width: 200px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);"
              >
                <option value="geral">Geral</option>
              </select>
            </div>
          </div>
          <div class="metric-card-content" style="min-height: 400px; padding: 20px;">
            <canvas id="graficoDisciplinas"></canvas>
          </div>
        </div>
      </div>

      <!-- Mensagem quando nenhum aluno foi selecionado -->
      <div id="mensagemInicial" class="metric-card-modern" style="text-align: center; padding: 48px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
        <h3 style="color: #003b54; margin-bottom: 8px;">Nenhum aluno selecionado</h3>
        <p style="color: #666;">Digite o nome ou matr√≠cula do aluno acima para visualizar o relat√≥rio individual</p>
        </div>
    </main>
      </div>

  <script>
    let grafico = null;
    let graficoDisciplinas = null;
    let alunoSelecionado = null;
    let listaAlunos = [];
    let timeoutBusca = null;
    let dadosDisciplinasGerais = [];
    let dadosDisciplinasPorSimulado = {}; // Cache dos dados por simulado

    // Carregar dados ao inicializar
    document.addEventListener('DOMContentLoaded', async () => {
      await carregarListaAlunos();
      await loadUserData();
    });

    async function carregarListaAlunos() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      try {
        const response = await fetch('/api/alunos', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          if (data.sucesso) {
            listaAlunos = data.alunos || [];
          }
        }
      } catch (error) {
        console.error('Erro ao carregar lista de alunos:', error);
      }
    }

    function buscarAlunos(event) {
      const termo = event.target.value.trim().toLowerCase();
      const sugestoesDiv = document.getElementById('sugestoesAlunos');
      
      if (termo.length < 2) {
        sugestoesDiv.style.display = 'none';
        return;
      }

      // Filtrar alunos
      const alunosFiltrados = listaAlunos.filter(aluno => 
        aluno.nome_completo.toLowerCase().includes(termo) ||
        aluno.matricula.toLowerCase().includes(termo)
      ).slice(0, 5); // Limitar a 5 sugest√µes

      if (alunosFiltrados.length === 0) {
        sugestoesDiv.style.display = 'none';
        return;
      }

      // Exibir sugest√µes
      sugestoesDiv.innerHTML = alunosFiltrados.map((aluno, index) => `
        <div 
          style="padding: 12px 16px; cursor: pointer; border-bottom: ${index < alunosFiltrados.length - 1 ? '1px solid #eee' : 'none'}; transition: background 0.2s;"
          onmouseover="this.style.background='#f0f7fa'"
          onmouseout="this.style.background='white'"
          onclick="selecionarAluno('${aluno.id}', '${aluno.nome_completo.replace(/'/g, "\\'")}', '${aluno.matricula || 'N/A'}')"
        >
          <div style="font-weight: 600; color: #003b54; margin-bottom: 4px;">${aluno.nome_completo}</div>
          <div style="font-size: 13px; color: #666;">Matr√≠cula: <span style="color: #008cc4; font-weight: 500;">${aluno.matricula || 'N/A'}</span></div>
        </div>
      `).join('');
      
      sugestoesDiv.style.display = 'block';
    }

    function selecionarAluno(id, nome, matricula) {
      alunoSelecionado = { id, nome, matricula };
      document.getElementById('buscaAluno').value = nome;
      document.getElementById('sugestoesAlunos').style.display = 'none';
      
      // Preenche os campos, mas s√≥ exibiremos o container ap√≥s buscar com sucesso
      document.getElementById('nomeAlunoSelecionado').textContent = nome;
      document.getElementById('matriculaAlunoSelecionado').textContent = matricula || 'N/A';
      document.getElementById('infoAlunoSelecionado').style.display = 'none';
    }

    async function buscarRelatorio() {
      if (!alunoSelecionado) {
        showToast('Por favor, selecione um aluno da lista de sugest√µes', 'warning');
        return;
      }

      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      try {
        document.getElementById('btnBuscarText').textContent = 'Buscando...';
        document.getElementById('btnBuscarSpinner').style.display = 'inline-block';
        document.getElementById('btnBuscar').disabled = true;

        const response = await fetch(`/api/relatorios/estatisticas-individual/${alunoSelecionado.id}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
            return;
          }
          if (response.status === 404) {
            showToast('Aluno n√£o encontrado ou sem dados de relat√≥rio', 'warning');
            return;
          }
          throw new Error('Erro ao buscar relat√≥rio');
        }

        const data = await response.json();
        
        if (data.sucesso && data.estatisticas) {
          atualizarMetricas(data.estatisticas);
          atualizarGrafico(data.estatisticas.desempenho_por_gabarito || data.estatisticas.desempenho_tempo);
          
          // Armazenar dados gerais e popular dropdown de simulados
          dadosDisciplinasGerais = data.estatisticas.media_por_disciplina || [];
          atualizarGraficoDisciplinas(dadosDisciplinasGerais);
          popularDropdownSimulados(data.estatisticas.desempenho_por_gabarito || []);
          
          atualizarTabelaSimulados(data.estatisticas.desempenho_por_gabarito || []);

          // Exibir container din√¢mico com info do aluno somente ap√≥s buscar
          const infoDiv = document.getElementById('infoAlunoSelecionado');
          document.getElementById('nomeAlunoSelecionado').textContent = alunoSelecionado.nome;
          document.getElementById('matriculaAlunoSelecionado').textContent = alunoSelecionado.matricula || 'N/A';
          
          // Descobrir etapa a partir do desempenho por gabarito (mais frequente)
          const porGabarito = data.estatisticas.desempenho_por_gabarito || [];
          let etapa = 'N/A';
          if (porGabarito.length > 0) {
            const contagem = {};
            porGabarito.forEach(item => {
              const e = (item.etapa || '').toString().trim();
              if (!e) return;
              contagem[e] = (contagem[e] || 0) + 1;
            });
            const etapasOrdenadas = Object.entries(contagem).sort((a, b) => b[1] - a[1]);
            if (etapasOrdenadas.length > 0) etapa = etapasOrdenadas[0][0];
          }
          document.getElementById('etapaAlunoSelecionado').textContent = etapa;

          infoDiv.style.display = 'block';

          document.getElementById('mensagemInicial').style.display = 'none';
          document.getElementById('containerMetricas').style.display = 'block';
          document.getElementById('containerRelatorioSimulados').style.display = 'block';
          
          // Resetar dropdown para "Geral" ao carregar novo relat√≥rio
          const selectFiltro = document.getElementById('filtroSimulado');
          if (selectFiltro) {
            selectFiltro.value = 'geral';
          }
          
          showToast('Relat√≥rio carregado com sucesso!', 'success');
        } else {
          showToast('Erro ao carregar dados do relat√≥rio', 'error');
        }
      } catch (error) {
        console.error('Erro ao buscar relat√≥rio:', error);
        showToast('Erro ao buscar relat√≥rio. Tente novamente.', 'error');
      } finally {
        document.getElementById('btnBuscarText').textContent = 'Buscar';
        document.getElementById('btnBuscarSpinner').style.display = 'none';
        document.getElementById('btnBuscar').disabled = false;
      }
    }

    function atualizarMetricas(stats) {
      document.getElementById('qtdQuestoes').textContent = 
        stats.total_questoes.toLocaleString('pt-BR');
      document.getElementById('acertosTotais').textContent = 
        stats.total_acertos.toLocaleString('pt-BR');
      document.getElementById('taxaAcertos').textContent = 
        stats.taxa_acertos.toFixed(1) + '%';
      document.getElementById('maiorMediaDisciplina').textContent = 
        stats.maior_media_disciplina || '-';
      document.getElementById('menorMediaDisciplina').textContent = 
        stats.menor_media_disciplina || '-';
    }

    function atualizarGrafico(dados) {
  const ctx = document.getElementById('graficoDesempenho').getContext('2d');
      
      // Se tiver dados por gabarito, usar esses (mais √∫til)
      // Sen√£o, usar dados por tempo
      let labels = [];
      let medias = [];

      if (dados && dados.length > 0) {
        if (dados[0].nome) {
          // Dados por gabarito
          labels = dados.map(d => d.nome || `Simulado ${d.etapa || ''}`).slice(0, 10);
          medias = dados.map(d => d.media || 0).slice(0, 10);
        } else if (dados[0].data) {
          // Dados por tempo
          labels = dados.map(d => {
            const date = new Date(d.data);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
          }).slice(0, 10);
          medias = dados.map(d => d.media || 0).slice(0, 10);
        }
      }

      if (labels.length === 0) {
        labels = ['Sem dados'];
        medias = [0];
      }

      if (grafico) {
        grafico.destroy();
      }

      grafico = new Chart(ctx, {
    type: 'line',
    data: {
          labels: labels,
      datasets: [{
        label: '% de Acertos',
            data: medias,
            borderColor: '#008cc4',
            backgroundColor: 'rgba(0, 140, 196, 0.1)',
        fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#008cc4',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
          maintainAspectRatio: false,
      plugins: {
        legend: {
              display: true,
              position: 'top',
          labels: {
            font: {
                  size: 14,
                  weight: 'bold'
                },
                color: '#003b54',
                padding: 15
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleFont: {
                size: 14,
                weight: 'bold'
              },
              bodyFont: {
                size: 13
              },
              padding: 12,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return `M√©dia: ${context.parsed.y.toFixed(1)}%`;
            }
          }
        }
      },
      scales: {
            x: {
              ticks: {
                font: {
                  size: 12,
                  weight: 'bold'
                },
                color: '#003b54'
              },
              grid: {
                display: false
              }
            },
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
                stepSize: 10,
            font: {
                  size: 12,
                  weight: 'bold'
                },
                color: '#003b54',
                callback: function(value) {
                  return value + '%';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)',
                lineWidth: 1
              }
            }
          },
          layout: {
            padding: {
              top: 10,
              right: 20,
              bottom: 10,
              left: 20
            }
          }
        }
      });
    }

    function popularDropdownSimulados(simulados) {
      const select = document.getElementById('filtroSimulado');
      if (!select) return;
      
      // Limpar op√ß√µes existentes (exceto "Geral")
      select.innerHTML = '<option value="geral">Geral</option>';
      
      // Limpar cache de dados por simulado
      dadosDisciplinasPorSimulado = {};
      
      if (!simulados || simulados.length === 0) {
        select.disabled = true;
        select.style.opacity = '0.6';
        select.style.cursor = 'not-allowed';
        return;
      }
      
      select.disabled = false;
      select.style.opacity = '1';
      select.style.cursor = 'pointer';
      
      // Ordenar por data (mais recente primeiro)
      const simuladosOrdenados = [...simulados].sort((a, b) => {
        const dataA = a.data ? new Date(a.data) : new Date(0);
        const dataB = b.data ? new Date(b.data) : new Date(0);
        return dataB - dataA;
      });
      
      // Adicionar op√ß√µes de simulados
      simuladosOrdenados.forEach((simulado) => {
        const option = document.createElement('option');
        option.value = simulado.id;
        option.textContent = `${simulado.nome || 'Simulado'} ${simulado.etapa ? `(${simulado.etapa})` : ''}`;
        select.appendChild(option);
      });
      
      // Resetar para "Geral"
      select.value = 'geral';
    }

    async function filtrarDisciplinasPorSimulado(event) {
      const gabaritoId = event.target.value;
      
      if (!alunoSelecionado) {
        showToast('Selecione um aluno primeiro', 'warning');
        event.target.value = 'geral'; // Resetar dropdown
        return;
      }
      
      // Se for "geral", usar dados gerais j√° carregados
      if (gabaritoId === 'geral') {
        atualizarGraficoDisciplinas(dadosDisciplinasGerais);
        return;
      }
      
      // Verificar se j√° temos os dados em cache
      if (dadosDisciplinasPorSimulado[gabaritoId]) {
        atualizarGraficoDisciplinas(dadosDisciplinasPorSimulado[gabaritoId]);
        return;
      }
      
      // Buscar dados do servidor
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      try {
        showLoading('Carregando desempenho por disciplina...');
        
        const response = await fetch(`/api/relatorios/estatisticas-individual/${alunoSelecionado.id}/disciplinas/${gabaritoId}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
            return;
          }
          
          // Se for 404, pode n√£o haver dados para esse simulado espec√≠fico
          if (response.status === 404) {
            const errorData = await response.json().catch(() => ({}));
            showToast(errorData.erro || 'Nenhum dado encontrado para este simulado', 'warning');
            event.target.value = 'geral'; // Resetar para geral
            atualizarGraficoDisciplinas(dadosDisciplinasGerais);
            return;
          }
          
          // Se for 500, pode ser um erro no servidor
          if (response.status === 500) {
            const errorData = await response.json().catch(() => ({}));
            const mensagem = errorData.detalhes 
              ? `Erro no servidor: ${errorData.detalhes}` 
              : 'Erro interno do servidor. Tente novamente ou verifique os logs.';
            showToast(mensagem, 'error');
            event.target.value = 'geral';
            atualizarGraficoDisciplinas(dadosDisciplinasGerais);
            return;
          }
          
          // Para outros erros, tentar obter detalhes
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.erro || `Erro HTTP ${response.status}: Erro ao buscar desempenho por disciplina`);
        }
        
        const data = await response.json();
        
        if (data.sucesso) {
          const disciplinas = data.media_por_disciplina || [];
          
          // Armazenar em cache (mesmo se for array vazio)
          dadosDisciplinasPorSimulado[gabaritoId] = disciplinas;
          
          if (disciplinas.length === 0) {
            showToast('Nenhuma disciplina encontrada para este simulado', 'info');
            // Mostrar gr√°fico vazio ao inv√©s de erro
            atualizarGraficoDisciplinas([]);
          } else {
            atualizarGraficoDisciplinas(disciplinas);
          }
        } else {
          showToast(data.erro || 'Erro ao carregar dados do desempenho por disciplina', 'error');
          event.target.value = 'geral'; // Resetar para geral
          atualizarGraficoDisciplinas(dadosDisciplinasGerais);
        }
      } catch (error) {
        console.error('Erro ao filtrar disciplinas:', error);
        
        // Verificar tipo de erro
        let mensagemErro = 'Erro ao filtrar disciplinas. Tente novamente.';
        
        if (error.name === 'TypeError' && (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_REFUSED') || error.message.includes('ERR_CONNECTION_RESET'))) {
          mensagemErro = 'Erro de conex√£o com o servidor. Verifique se o servidor est√° rodando na porta 3000.';
        } else if (error.message) {
          mensagemErro = error.message;
        }
        
        showToast(mensagemErro, 'error');
        
        // Resetar para geral em caso de erro
        try {
          event.target.value = 'geral';
          atualizarGraficoDisciplinas(dadosDisciplinasGerais);
        } catch (resetError) {
          console.error('Erro ao resetar para geral:', resetError);
        }
      } finally {
        hideLoading();
      }
    }

    function atualizarTabelaSimulados(simulados) {
      const corpoTabela = document.getElementById('corpoTabelaSimulados');
      const mensagemSemSimulados = document.getElementById('mensagemSemSimulados');
      const container = document.getElementById('containerRelatorioSimulados');
      
      let dados = Array.isArray(simulados) ? simulados : [];
      
      if (dados.length === 0) {
        corpoTabela.innerHTML = '';
        mensagemSemSimulados.style.display = 'block';
        if (container) container.style.display = 'none';
        return;
      }
      
      mensagemSemSimulados.style.display = 'none';
      if (container) container.style.display = 'block';
      
      // Ordenar por data (mais recente primeiro)
      dados = [...dados].sort((a, b) => {
        const dataA = a.data ? new Date(a.data) : new Date(0);
        const dataB = b.data ? new Date(b.data) : new Date(0);
        return dataB - dataA;
      });
      
      corpoTabela.innerHTML = dados.map((simulado, index) => {
        const nome = simulado.nome || 'Simulado sem nome';
        const etapa = simulado.etapa || 'N/A';
        const totalQuestoes = Number(simulado.total_questoes || 0);
        const acertos = Number(simulado.acertos || 0);
        const media = Number(simulado.media || 0);
        const dataFormatada = simulado.data 
          ? new Date(simulado.data).toLocaleDateString('pt-BR', { 
              day: '2-digit', 
              month: '2-digit', 
              year: 'numeric' 
            })
          : 'N/A';
        
        // Cor da linha baseada na m√©dia
        let corFundo = 'transparent';
        let corTexto = '#003b54';
        if (media >= 70) {
          corFundo = 'rgba(46, 204, 113, 0.1)';
        } else if (media >= 50) {
          corFundo = 'rgba(241, 196, 15, 0.1)';
        } else {
          corFundo = 'rgba(231, 76, 60, 0.1)';
        }
        
        // Cor da m√©dia
        let corMedia = '#003b54';
        if (media >= 70) {
          corMedia = '#2ecc71';
        } else if (media >= 50) {
          corMedia = '#f1c40f';
        } else {
          corMedia = '#e74c3c';
        }
        
        return `
          <tr style="background: ${corFundo}; transition: background 0.2s;" 
              onmouseover="this.style.background='rgba(0, 140, 196, 0.1)'" 
              onmouseout="this.style.background='${corFundo}'">
            <td style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: ${corTexto};">
              ${nome}
            </td>
            <td style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; text-align: center; color: #666;">
              ${etapa}
            </td>
            <td style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; text-align: center; color: #666;">
              ${totalQuestoes.toLocaleString('pt-BR')}
            </td>
            <td style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; text-align: center; color: #666; font-weight: 600;">
              ${acertos.toLocaleString('pt-BR')}
            </td>
            <td style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; text-align: center; font-weight: 700; color: ${corMedia}; font-size: 15px;">
              ${media.toFixed(1)}%
            </td>
            <td style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; text-align: center; color: #666;">
              ${dataFormatada}
            </td>
          </tr>
        `;
      }).join('');
    }

    function atualizarGraficoDisciplinas(disciplinas) {
      const ctx = document.getElementById('graficoDisciplinas').getContext('2d');
      
      let dados = Array.isArray(disciplinas) ? disciplinas : [];
      // Ordenar por total de quest√µes desc para melhor leitura
      dados = [...dados].sort((a, b) => (b.total_questoes || 0) - (a.total_questoes || 0));

      const labels = dados.length > 0 ? dados.map(d => {
        const nome = d.nome || 'Disciplina';
        return nome.length > 30 ? nome.substring(0, 27) + '...' : nome;
      }) : ['Sem dados'];

      const totais = dados.length > 0 ? dados.map(d => Number(d.total_respostas || d.total_questoes || 0)) : [0];
      const acertos = dados.length > 0 ? dados.map(d => Number(d.acertos || 0)) : [0];

      if (graficoDisciplinas) {
        graficoDisciplinas.destroy();
      }

      graficoDisciplinas = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Quest√µes',
              data: totais,
              backgroundColor: '#008cc4',
              borderColor: '#006a9a',
              borderWidth: 2,
              borderRadius: 6,
              categoryPercentage: 0.6,
              barPercentage: 0.5,
              maxBarThickness: 40,
              order: 0
            },
            {
              label: 'Acertos',
              data: acertos,
              backgroundColor: '#2ecc71',
              borderColor: '#1e9e58',
              borderWidth: 2,
              borderRadius: 6,
              categoryPercentage: 0.6,
              barPercentage: 0.5,
              maxBarThickness: 40,
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: { size: 14, weight: 'bold' },
                color: '#003b54',
                padding: 15
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 },
              padding: 12,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.parsed.y}`;
                }
              }
            }
          },
          scales: {
            x: {
              stacked: false,
              categoryPercentage: 0.7,
              barPercentage: 0.6,
              ticks: {
                font: { size: 11, weight: 'bold' },
                color: '#003b54',
                maxRotation: 45,
                minRotation: 45,
                autoSkip: false
              },
              grid: { display: false }
            },
            y: {
              beginAtZero: true,
              stacked: false,
              ticks: {
                stepSize: 5,
                font: { size: 12, weight: 'bold' },
                color: '#003b54'
              },
              grid: { color: 'rgba(0, 0, 0, 0.1)', lineWidth: 1 }
            }
          },
          layout: {
            padding: { top: 10, right: 20, bottom: 10, left: 20 }
          }
        }
      });
    }

    // Fechar sugest√µes ao clicar fora
    document.addEventListener('click', function(event) {
      const sugestoesDiv = document.getElementById('sugestoesAlunos');
      const buscaInput = document.getElementById('buscaAluno');
      const buscaContainer = buscaInput ? buscaInput.closest('.input-group') : null;
      
      if (buscaContainer && !buscaContainer.contains(event.target)) {
        sugestoesDiv.style.display = 'none';
      }
    });

    // Limpar sele√ß√£o quando o campo for limpo
    document.getElementById('buscaAluno').addEventListener('input', function(e) {
      if (e.target.value.trim() === '') {
        alunoSelecionado = null;
        document.getElementById('infoAlunoSelecionado').style.display = 'none';
      }
    });
</script>
</body>
</html>

