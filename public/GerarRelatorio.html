<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Relat√≥rio Individual</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="utils.js" defer></script>
  <style>
    #mensagemInicial:hover {
      transform: none !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08) !important;
    }
  </style>
</head>
<body>
  <!-- Skip Links para navega√ß√£o por teclado -->
  <a href="#main-content" class="skip-link">Pular para conte√∫do principal</a>
  <a href="#main-navigation" class="skip-link">Pular para navega√ß√£o principal</a>
  
<div class="home-container">
  <aside class="sidebar">
    <div class="profile" id="sidebar-profile">
      <img src="https://img.icons8.com/ios-filled/100/ffffff/user-male-circle.png" alt="Perfil"/>
      <span style="opacity: 0;"><!-- Carregando... --></span>
    </div>
      <nav class="nav-links" role="navigation" aria-label="Menu principal" id="main-navigation">
        <a href="home.html">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/home-page.png" alt="" /> Home
        </a>
      <div class="dropdown">
          <a href="RelatorioGeral.html">
            <img src="https://img.icons8.com/ios-filled/24/ffffff/report-card.png" alt="" /> Gerar Relat√≥rio
        </a>
        <div class="dropdown-options">
          <a href="RelatorioGeral.html" class="sub">Relat√≥rio Geral</a>
          <a href="GerarRelatorio.html" class="sub active">Relat√≥rio Individual</a>
        </div>
      </div>
      <a href="Cadastrar.html">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/add-user-male.png" alt="" /> Cadastrar
      </a>
      <a href="CadastrarGabarito.html">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/test-passed.png" alt="" /> Simulado
      </a>
      <a href="AgendarSessao.html">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/calendar.png" alt="" /> Agendar Sess√£o
      </a>
    </nav>
  </aside>

    <main class="content" id="main-content" role="main">
      <!-- Breadcrumb e User Profile -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xl);">
        <nav class="breadcrumb" aria-label="Breadcrumb" style="margin: 0;">
          <a href="home.html">Home</a>
          <span class="breadcrumb-separator">/</span>
          <a href="RelatorioGeral.html">Relat√≥rios</a>
          <span class="breadcrumb-separator">/</span>
          <span>Relat√≥rio Individual</span>
        </nav>
        <div class="user-profile-menu">
          <button class="user-avatar-button" id="user-menu-button" aria-label="Abrir menu do usu√°rio">AS</button>
          <div class="dropdown-menu hidden" id="user-dropdown">
            <div class="dropdown-header">
              <p class="user-name">Anna Souza</p>
              <p class="user-email">anna.souza@uea.edu.br</p>
              <p class="user-score"><strong>Professor</strong></p>
            </div>
            <ul>
              <li><a href="meuperfil.html"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> Meu Perfil</a></li>
              <li><a href="configuracoes.html"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-4.44a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.88z"></path><path d="M18 2h-2.17a2 2 0 0 0-1.41.59L12 5l-2.41-2.41A2 2 0 0 0 8.17 2H6"></path><path d="M9.5 2a2.83 2.83 0 0 1 5 0"></path></svg> Configura√ß√µes</a></li>
              <li><a href="#" onclick="logout()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg> Sair</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="dashboard-header">
        <div>
          <h2>Relat√≥rio Individual</h2>
          <p class="dashboard-subtitle">Consulte o desempenho detalhado de um aluno espec√≠fico</p>
        </div>
      </div>

      <!-- Campo de Busca -->
      <div class="metric-card-modern" style="margin-bottom: var(--spacing-xl);">
        <div class="metric-card-header">
          <h3>Buscar Aluno</h3>
          <span class="metric-icon">üîç</span>
        </div>
        <div class="metric-card-content" style="padding: var(--spacing-xl);">
          <!-- Campo de Busca e Bot√£o na mesma linha -->
          <div class="input-group" style="margin-bottom: var(--spacing-md); max-width: 100%;">
            <label for="buscaAluno" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm); color: var(--color-primary-darker); font-weight: 600;">Nome ou Matr√≠cula do Aluno</label>
            <div style="display: flex; gap: var(--spacing-md); align-items: flex-start;">
              <div style="position: relative; flex: 1; min-width: 0;">
                <input 
                  type="text" 
                  id="buscaAluno" 
                  placeholder="Digite o nome ou matr√≠cula do aluno"
                  autocomplete="off"
                  onkeyup="buscarAlunos(event)"
                  onfocus="if(this.value.length >= 2) buscarAlunos(event)"
                  aria-label="Buscar aluno por nome ou matr√≠cula"
                  aria-describedby="buscaAlunoHint"
                  aria-autocomplete="list"
                  aria-expanded="false"
                  aria-controls="sugestoesAlunos"
                  style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: var(--font-size-sm); outline: none; box-shadow: var(--shadow-sm); transition: border-color var(--transition-base);"
                />
                <span id="buscaAlunoHint" class="sr-only">Digite pelo menos 2 caracteres para buscar alunos</span>
                <div 
                  id="sugestoesAlunos" 
                  role="listbox"
                  aria-label="Sugest√µes de alunos"
                  style="position: absolute; top: 100%; left: 0; right: 0; width: 100%; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-sm); margin-top: var(--spacing-xs); max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: var(--shadow-md);"
                ></div>
              </div>
              <button 
                type="button" 
                class="btn-primary" 
                onclick="buscarRelatorio()"
                id="btnBuscar"
                aria-label="Buscar relat√≥rio do aluno selecionado"
                style="padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-sm); white-space: nowrap; margin-top: 0; height: fit-content; align-self: flex-end; min-width: 100px;"
              >
                <span id="btnBuscarText">Buscar</span>
                <span id="btnBuscarSpinner" class="loading-spinner" style="display: none;" aria-hidden="true"></span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Informa√ß√µes do Aluno Selecionado (container din√¢mico ap√≥s buscar) -->
      <div id="infoAlunoSelecionado" class="metric-card-modern" style="display: none; padding: var(--spacing-md) var(--spacing-lg); background: linear-gradient(135deg, var(--color-background) 0%, rgba(0, 140, 196, 0.05) 100%); border-radius: var(--radius-md); border-left: 4px solid var(--color-primary); margin-bottom: var(--spacing-lg);">
        <div style="display: flex; align-items: center; gap: var(--spacing-md);">
          <div style="font-size: var(--font-size-xl); line-height: 1;">üë§</div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; color: var(--color-primary-darker); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="nomeAlunoSelecionado"></div>
            <div style="color: var(--color-text-light); font-size: var(--font-size-xs); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Matr√≠cula: <span id="matriculaAlunoSelecionado" style="font-weight: 600; color: var(--color-primary);"></span></div>
            <div style="color: var(--color-text-light); font-size: var(--font-size-xs); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Ano/Etapa: <span id="etapaAlunoSelecionado" style="font-weight: 600; color: var(--color-primary);">N/A</span></div>
          </div>
        </div>
      </div>

      <!-- Cards de M√©tricas (ocultos inicialmente) -->
      <div id="containerMetricas" style="display: none;">
        <div class="metrics-grid">
          <div class="metric-card-modern">
            <div class="metric-card-header">
              <h3>Quest√µes Aplicadas</h3>
              <span class="metric-icon">üìä</span>
            </div>
            <div class="metric-card-content" style="justify-content: center; align-items: center; min-height: 120px; padding: var(--spacing-lg);">
              <div class="metric-value">
                <span class="value-number" id="qtdQuestoes">0</span>
                <span class="value-label">quest√µes respondidas<br><small>(total de quest√µes respondidas pelo aluno)</small></span>
              </div>
            </div>
          </div>

          <div class="metric-card-modern">
            <div class="metric-card-header">
              <h3>Acertos</h3>
              <span class="metric-icon">‚úÖ</span>
            </div>
            <div class="metric-card-content" style="justify-content: center; align-items: center; min-height: 120px; padding: var(--spacing-lg);">
              <div class="metric-value">
                <span class="value-number" id="acertosTotais">0</span>
                <span class="value-label">respostas corretas<br><small>(total de acertos do aluno)</small></span>
              </div>
        </div>
      </div>

          <div class="metric-card-modern">
            <div class="metric-card-header">
              <h3>Taxa de Acertos</h3>
              <span class="metric-icon">üìà</span>
            </div>
            <div class="metric-card-content" style="justify-content: center; align-items: center; min-height: 120px; padding: var(--spacing-lg);">
              <div class="metric-value">
                <span class="value-number" id="taxaAcertos">0%</span>
                <span class="value-label">percentual de acertos<br><small>(m√©dia de acertos do aluno)</small></span>
              </div>
            </div>
          </div>

          <div class="metric-card-modern">
            <div class="metric-card-header">
              <h3>Maior M√©dia</h3>
              <span class="metric-icon">üèÜ</span>
            </div>
            <div class="metric-card-content" style="justify-content: center; align-items: center; min-height: 120px; padding: var(--spacing-lg);">
              <div class="metric-value">
                <span class="value-number" id="maiorMediaDisciplina">-</span>
                <span class="value-label">disciplina com melhor desempenho</span>
              </div>
          </div>
          </div>

          <div class="metric-card-modern">
            <div class="metric-card-header">
              <h3>Menor M√©dia</h3>
              <span class="metric-icon">üìâ</span>
          </div>
            <div class="metric-card-content" style="justify-content: center; align-items: center; min-height: 120px; padding: var(--spacing-lg);">
              <div class="metric-value">
                <span class="value-number" id="menorMediaDisciplina">-</span>
                <span class="value-label">disciplina que precisa de aten√ß√£o</span>
          </div>
          </div>
        </div>

          <div class="metric-card-modern">
            <div class="metric-card-header">
              <h3>Previs√£o</h3>
              <span class="metric-icon">üîÆ</span>
            </div>
            <div class="metric-card-content" style="justify-content: center; align-items: center; min-height: 120px; padding: var(--spacing-lg);">
              <div class="metric-value">
                <span class="value-number" id="previsaoAcertos">N/A</span>
                <span class="value-label">N¬∞ acertos esperado no dia da prova</span>
              </div>
            </div>
          </div>
        </div>
      </div>

        <!-- Gr√°fico de Desempenho ao Longo do Tempo -->
        <div class="metric-card-modern full-width" style="margin-top: var(--spacing-xl);">
          <div class="metric-card-header">
            <h3>Desempenho ao Longo do Tempo</h3>
          </div>
          <div class="metric-card-content" style="min-height: 350px; position: relative; width: 100%;">
            <canvas 
              id="graficoDesempenho" 
              role="img"
              aria-label="Gr√°fico de desempenho do aluno ao longo do tempo"
              style="max-width: 100%; width: 100% !important; height: 320px !important; display: block;"
            ></canvas>
          </div>
        </div>

        <!-- Relat√≥rio Individual por Simulado -->
        <div id="containerRelatorioSimulados" class="metric-card-modern full-width" style="margin-top: var(--spacing-xl); display: none;">
          <div class="metric-card-header">
            <h3>Relat√≥rio Individual por Simulado</h3>
            <span class="metric-icon">üìã</span>
          </div>
          <div class="metric-card-content" style="padding: var(--spacing-xl);">
            <div id="tabelaSimulados" style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                  <tr style="background: linear-gradient(135deg, #008cc4 0%, #006a9a 100%); color: white; border-radius: 8px;">
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; border-radius: 8px 0 0 0;">Simulado</th>
                    <th style="padding: 12px 16px; text-align: center; font-weight: 600;">Etapa</th>
                    <th style="padding: 12px 16px; text-align: center; font-weight: 600;">Quest√µes</th>
                    <th style="padding: 12px 16px; text-align: center; font-weight: 600;">Quest√µes Capturadas</th>
                    <th style="padding: 12px 16px; text-align: center; font-weight: 600;">Acertos</th>
                    <th style="padding: 12px 16px; text-align: center; font-weight: 600;">M√©dia (%)</th>
                    <th style="padding: 12px 16px; text-align: center; font-weight: 600; border-radius: 0 8px 0 0;">Data</th>
                  </tr>
                </thead>
                <tbody id="corpoTabelaSimulados">
                  <!-- Dados ser√£o inseridos aqui dinamicamente -->
                </tbody>
              </table>
              <div id="mensagemSemSimulados" style="text-align: center; padding: 48px; color: #666; display: none;">
                <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                <p>Nenhum simulado encontrado para este aluno.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Desempenho por Disciplina -->
        <div class="metric-card-modern full-width" style="margin-top: var(--spacing-xl);">
          <div class="metric-card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
            <h3>Desempenho por Disciplina</h3>
            <div style="display: flex; align-items: center; gap: var(--spacing-md); flex-wrap: wrap;">
              <label for="filtroSimulado" style="font-size: var(--font-size-sm); color: var(--color-primary-darker); font-weight: 600;">Filtrar por:</label>
              <select 
                id="filtroSimulado" 
                onchange="filtrarDisciplinasPorSimulado(event)"
                style="padding: var(--spacing-sm) var(--spacing-md); border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: var(--font-size-sm); outline: none; cursor: pointer; background: var(--color-surface); color: var(--color-primary-darker); min-width: 200px; box-shadow: var(--shadow-sm); transition: border-color var(--transition-base);"
              >
                <option value="geral">Geral</option>
              </select>
            </div>
          </div>
          <div class="metric-card-content" style="min-height: 350px;">
            <canvas 
              id="graficoDisciplinas" 
              role="img"
              aria-label="Gr√°fico de desempenho por disciplina"
              style="max-width: 100%; height: 320px !important;"
            ></canvas>
          </div>
        </div>

      <!-- Mensagem quando nenhum aluno foi selecionado -->
      <div id="mensagemInicial" class="metric-card-modern full-width" style="text-align: center; padding: var(--spacing-4xl); margin-top: var(--spacing-xl);">
        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üìä</div>
        <h3 style="color: var(--color-primary-darker); margin-bottom: var(--spacing-sm);">Nenhum aluno selecionado</h3>
        <p style="color: var(--color-text-light);">Digite o nome ou matr√≠cula do aluno acima para visualizar o relat√≥rio individual</p>
      </div>
    </main>
  </div>

  <script>
    let grafico = null;
    let graficoDisciplinas = null;
    let alunoSelecionado = null;
    let listaAlunos = [];
    let timeoutBusca = null;
    let dadosDisciplinasGerais = [];
    let dadosDisciplinasPorSimulado = {}; // Cache dos dados por simulado

    // Carregar dados ao inicializar
    document.addEventListener('DOMContentLoaded', async () => {
      await carregarListaAlunos();
      await loadUserData();
    });

    async function carregarListaAlunos() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      try {
        showLoading('Carregando lista de alunos...');
        const response = await fetch('/api/alunos', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          if (data.sucesso) {
            listaAlunos = data.alunos || [];
          }
        } else {
          console.warn('Erro ao carregar lista de alunos:', response.status);
        }
      } catch (error) {
        console.error('Erro ao carregar lista de alunos:', error);
        showToast('Erro ao carregar lista de alunos', 'error');
      } finally {
        hideLoading();
      }
    }

    function buscarAlunos(event) {
      const termo = event.target.value.trim().toLowerCase();
      const sugestoesDiv = document.getElementById('sugestoesAlunos');
      
      if (termo.length < 2) {
        sugestoesDiv.style.display = 'none';
        return;
      }

      // Filtrar alunos
      const alunosFiltrados = listaAlunos.filter(aluno => 
        aluno.nome_completo.toLowerCase().includes(termo) ||
        aluno.matricula.toLowerCase().includes(termo)
      ).slice(0, 5); // Limitar a 5 sugest√µes

      if (alunosFiltrados.length === 0) {
        sugestoesDiv.style.display = 'none';
        return;
      }

      // Exibir sugest√µes
      sugestoesDiv.innerHTML = alunosFiltrados.map((aluno, index) => `
        <div 
          style="padding: 12px 16px; cursor: pointer; border-bottom: ${index < alunosFiltrados.length - 1 ? '1px solid #eee' : 'none'}; transition: background 0.2s;"
          onmouseover="this.style.background='#f0f7fa'"
          onmouseout="this.style.background='white'"
          onclick="selecionarAluno('${aluno.id}', '${aluno.nome_completo.replace(/'/g, "\\'")}', '${aluno.matricula || 'N/A'}')"
        >
          <div style="font-weight: 600; color: #003b54; margin-bottom: 4px;">${aluno.nome_completo}</div>
          <div style="font-size: 13px; color: #666;">Matr√≠cula: <span style="color: #008cc4; font-weight: 500;">${aluno.matricula || 'N/A'}</span></div>
        </div>
      `).join('');
      
      sugestoesDiv.style.display = 'block';
    }

    async function selecionarAluno(id, nome, matricula) {
      alunoSelecionado = { id, nome, matricula };
      document.getElementById('buscaAluno').value = nome;
      document.getElementById('sugestoesAlunos').style.display = 'none';
      
      // Preenche os campos, mas s√≥ exibiremos o container ap√≥s buscar com sucesso
      document.getElementById('nomeAlunoSelecionado').textContent = nome;
      document.getElementById('matriculaAlunoSelecionado').textContent = matricula || 'N/A';
      document.getElementById('infoAlunoSelecionado').style.display = 'none';
      
      // Buscar relat√≥rio automaticamente ao selecionar o aluno
      await buscarRelatorio();
    }

    async function buscarRelatorio() {
      if (!alunoSelecionado) {
        showToast('Por favor, selecione um aluno da lista de sugest√µes', 'warning');
        return;
      }

      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      try {
        document.getElementById('btnBuscarText').textContent = 'Buscando...';
        document.getElementById('btnBuscarSpinner').style.display = 'inline-block';
        document.getElementById('btnBuscar').disabled = true;

        const response = await fetch(`/api/relatorios/estatisticas-individual/${alunoSelecionado.id}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
            return;
          }
          if (response.status === 404) {
            showToast('Aluno n√£o encontrado ou sem dados de relat√≥rio', 'warning', 5000);
            return;
          }
          throw new Error('Erro ao buscar relat√≥rio');
        }

        const data = await response.json();
        
        if (data.sucesso && data.estatisticas) {
          atualizarMetricas(data.estatisticas);
          atualizarGrafico(data.estatisticas.desempenho_por_gabarito || data.estatisticas.desempenho_tempo);
          
          // Armazenar dados gerais e popular dropdown de simulados
          dadosDisciplinasGerais = data.estatisticas.media_por_disciplina || [];
          popularDropdownSimulados(data.estatisticas.desempenho_por_gabarito || []);
          
          atualizarTabelaSimulados(data.estatisticas.desempenho_por_gabarito || []);

          // Exibir container din√¢mico com info do aluno somente ap√≥s buscar
          const infoDiv = document.getElementById('infoAlunoSelecionado');
          document.getElementById('nomeAlunoSelecionado').textContent = alunoSelecionado.nome;
          document.getElementById('matriculaAlunoSelecionado').textContent = alunoSelecionado.matricula || 'N/A';
          
          // Descobrir etapa a partir do desempenho por gabarito (mais frequente)
          const porGabarito = data.estatisticas.desempenho_por_gabarito || [];
          let etapa = 'N/A';
          if (porGabarito.length > 0) {
            const contagem = {};
            porGabarito.forEach(item => {
              const e = (item.etapa || '').toString().trim();
              if (!e) return;
              contagem[e] = (contagem[e] || 0) + 1;
            });
            const etapasOrdenadas = Object.entries(contagem).sort((a, b) => b[1] - a[1]);
            if (etapasOrdenadas.length > 0) etapa = etapasOrdenadas[0][0];
          }
          document.getElementById('etapaAlunoSelecionado').textContent = etapa;

          infoDiv.style.display = 'block';

          document.getElementById('mensagemInicial').style.display = 'none';
          document.getElementById('containerMetricas').style.display = 'block';
          document.getElementById('containerRelatorioSimulados').style.display = 'block';
          
          // Resetar dropdown para "Geral" ao carregar novo relat√≥rio
          const selectFiltro = document.getElementById('filtroSimulado');
          if (selectFiltro) {
            selectFiltro.value = 'geral';
          }
          
          // Aguardar um frame para garantir que o container est√° vis√≠vel antes de atualizar o gr√°fico
          // Isso garante que o canvas tenha as dimens√µes corretas
          requestAnimationFrame(() => {
            setTimeout(() => {
              atualizarGraficoDisciplinas(dadosDisciplinasGerais);
            }, 100);
          });
          
          showToast('Relat√≥rio carregado com sucesso!', 'success');
        } else {
          showToast('Erro ao carregar dados do relat√≥rio', 'error');
        }
      } catch (error) {
        console.error('Erro ao buscar relat√≥rio:', error);
        showToast('Erro ao buscar relat√≥rio. Tente novamente.', 'error');
      } finally {
        document.getElementById('btnBuscarText').textContent = 'Buscar';
        document.getElementById('btnBuscarSpinner').style.display = 'none';
        document.getElementById('btnBuscar').disabled = false;
      }
    }

    function atualizarMetricas(stats) {
      document.getElementById('qtdQuestoes').textContent = 
        stats.total_questoes.toLocaleString('pt-BR');
      document.getElementById('acertosTotais').textContent = 
        stats.total_acertos.toLocaleString('pt-BR');
      document.getElementById('taxaAcertos').textContent = 
        stats.taxa_acertos.toFixed(1) + '%';
      document.getElementById('maiorMediaDisciplina').textContent = 
        stats.maior_media_disciplina || '-';
      document.getElementById('menorMediaDisciplina').textContent = 
        stats.menor_media_disciplina || '-';
    }

    function atualizarGrafico(dados) {
      const canvas = document.getElementById('graficoDesempenho');
      const ctx = canvas.getContext('2d');
      
      // Configurar alta resolu√ß√£o para telas Retina
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      
      // Ajustar tamanho do canvas para alta resolu√ß√£o
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      
      // Ajustar estilo do canvas para manter tamanho visual
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      
      // Se tiver dados por gabarito, usar esses (mais √∫til)
      // Sen√£o, usar dados por tempo
      let labels = [];
      let medias = [];

      if (dados && dados.length > 0) {
        // Ordenar dados do mais antigo para o mais novo (cronol√≥gico)
        let dadosOrdenados = [...dados];
        
        if (dados[0].nome) {
          // Dados por gabarito - ordenar por data (mais antigo primeiro)
          dadosOrdenados.sort((a, b) => {
            const dataA = a.data ? new Date(a.data) : new Date(0);
            const dataB = b.data ? new Date(b.data) : new Date(0);
            return dataA - dataB; // ASC: mais antigo primeiro
          });
          
          labels = dadosOrdenados.map(d => d.nome || `Simulado ${d.etapa || ''}`).slice(0, 10);
          medias = dadosOrdenados.map(d => d.media || 0).slice(0, 10);
        } else if (dados[0].data) {
          // Dados por tempo - j√° devem vir ordenados, mas garantir ordem ASC
          dadosOrdenados.sort((a, b) => {
            const dataA = new Date(a.data);
            const dataB = new Date(b.data);
            return dataA - dataB; // ASC: mais antigo primeiro
          });
          
          labels = dadosOrdenados.map(d => {
            const date = new Date(d.data);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
          }).slice(0, 10);
          medias = dadosOrdenados.map(d => d.media || 0).slice(0, 10);
        }
      }

      if (labels.length === 0) {
        labels = ['Sem dados'];
        medias = [0];
      }

      if (grafico) {
        grafico.destroy();
      }

      // Obter cores das vari√°veis CSS para Chart.js
      const root = getComputedStyle(document.documentElement);
      const colorPrimary = root.getPropertyValue('--color-primary').trim() || '#008cc4';
      const colorPrimaryDarker = root.getPropertyValue('--color-primary-darker').trim() || '#003b54';
      const colorTextLight = root.getPropertyValue('--color-text-light').trim() || '#666666';
      const colorBorderLight = root.getPropertyValue('--color-border-light').trim() || '#e0e0e0';
      
      // Converter cor prim√°ria para rgba com transpar√™ncia
      const hexToRgba = (hex, alpha) => {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      };
      const colorPrimaryRgba = hexToRgba(colorPrimary, 0.1);

      // Reconfigurar canvas antes de criar novo gr√°fico (garantir alta resolu√ß√£o)
      const dprLine = window.devicePixelRatio || 1;
      const rectLine = canvas.getBoundingClientRect();
      canvas.width = rectLine.width * dprLine;
      canvas.height = rectLine.height * dprLine;
      ctx.scale(dprLine, dprLine);
      canvas.style.width = rectLine.width + 'px';
      canvas.style.height = rectLine.height + 'px';

      grafico = new Chart(ctx, {
    type: 'line',
    data: {
          labels: labels,
      datasets: [{
        label: '% de Acertos',
            data: medias,
            borderColor: colorPrimary,
            backgroundColor: colorPrimaryRgba,
        fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: colorPrimary,
            pointBorderColor: '#fff',
            pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      devicePixelRatio: window.devicePixelRatio || 2, // Alta resolu√ß√£o
      plugins: {
        legend: {
              display: true,
              position: 'top',
          labels: {
            font: {
                  size: 14,
                  weight: 'bold'
                },
                color: colorPrimaryDarker,
                padding: 15
              }
            },
            tooltip: {
              backgroundColor: colorPrimaryDarker,
              titleFont: {
                size: 14,
                weight: 'bold'
              },
              bodyFont: {
                size: 13
              },
              padding: 12,
              displayColors: false,
              cornerRadius: 8,
              callbacks: {
                label: function(context) {
                  return `M√©dia: ${context.parsed.y.toFixed(1)}%`;
            }
          }
        }
      },
      scales: {
            x: {
              ticks: {
                font: {
                  size: 12,
                  weight: 'bold'
                },
                color: colorPrimaryDarker
              },
              grid: {
                display: false
              }
            },
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
                stepSize: 10,
            font: {
                  size: 12,
                  weight: 'bold'
                },
                color: colorPrimaryDarker,
                callback: function(value) {
                  return value + '%';
                }
              },
              grid: {
                color: colorBorderLight,
                lineWidth: 1
              }
            }
          },
          layout: {
            padding: {
              top: 10,
              right: 20,
              bottom: 10,
              left: 20
            }
          }
        }
      });
    }

    function popularDropdownSimulados(simulados) {
      const select = document.getElementById('filtroSimulado');
      if (!select) return;
      
      // Limpar op√ß√µes existentes (exceto "Geral")
      select.innerHTML = '<option value="geral">Geral</option>';
      
      // Limpar cache de dados por simulado
      dadosDisciplinasPorSimulado = {};
      
      if (!simulados || simulados.length === 0) {
        select.disabled = true;
        select.style.opacity = '0.6';
        select.style.cursor = 'not-allowed';
        return;
      }
      
      select.disabled = false;
      select.style.opacity = '1';
      select.style.cursor = 'pointer';
      
      // Ordenar por data (mais recente primeiro)
      const simuladosOrdenados = [...simulados].sort((a, b) => {
        const dataA = a.data ? new Date(a.data) : new Date(0);
        const dataB = b.data ? new Date(b.data) : new Date(0);
        return dataB - dataA;
      });
      
      // Adicionar op√ß√µes de simulados
      simuladosOrdenados.forEach((simulado) => {
        const option = document.createElement('option');
        option.value = simulado.id;
        option.textContent = `${simulado.nome || 'Simulado'} ${simulado.etapa ? `(${simulado.etapa})` : ''}`;
        select.appendChild(option);
      });
      
      // Resetar para "Geral"
      select.value = 'geral';
    }

    async function filtrarDisciplinasPorSimulado(event) {
      const gabaritoId = event.target.value;
      
      if (!alunoSelecionado) {
        showToast('Selecione um aluno primeiro', 'warning');
        event.target.value = 'geral'; // Resetar dropdown
        return;
      }
      
      // Se for "geral", usar dados gerais j√° carregados
      if (gabaritoId === 'geral') {
        atualizarGraficoDisciplinas(dadosDisciplinasGerais);
        return;
      }
      
      // Verificar se j√° temos os dados em cache
      if (dadosDisciplinasPorSimulado[gabaritoId]) {
        atualizarGraficoDisciplinas(dadosDisciplinasPorSimulado[gabaritoId]);
        return;
      }
      
      // Buscar dados do servidor
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      try {
        showLoading('Carregando desempenho por disciplina...');
        
        const response = await fetch(`/api/relatorios/estatisticas-individual/${alunoSelecionado.id}/disciplinas/${gabaritoId}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
            return;
          }
          
          // Se for 404, pode n√£o haver dados para esse simulado espec√≠fico
          if (response.status === 404) {
            const errorData = await response.json().catch(() => ({}));
            showToast(errorData.erro || 'Nenhum dado encontrado para este simulado', 'warning');
            event.target.value = 'geral'; // Resetar para geral
            atualizarGraficoDisciplinas(dadosDisciplinasGerais);
            return;
          }
          
          // Se for 500, pode ser um erro no servidor
          if (response.status === 500) {
            const errorData = await response.json().catch(() => ({}));
            const mensagem = errorData.detalhes 
              ? `Erro no servidor: ${errorData.detalhes}` 
              : 'Erro interno do servidor. Tente novamente ou verifique os logs.';
            showToast(mensagem, 'error');
            event.target.value = 'geral';
            atualizarGraficoDisciplinas(dadosDisciplinasGerais);
            return;
          }
          
          // Para outros erros, tentar obter detalhes
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.erro || `Erro HTTP ${response.status}: Erro ao buscar desempenho por disciplina`);
        }
        
        const data = await response.json();
        
        if (data.sucesso) {
          const disciplinas = data.media_por_disciplina || [];
          
          console.log('[DEBUG] Dados recebidos do simulado:', {
            gabaritoId,
            gabaritoNome: data.gabarito?.nome,
            gabaritoEtapa: data.gabarito?.etapa,
            totalDisciplinas: disciplinas.length,
            disciplinas: disciplinas
          });
          
          // Armazenar em cache (mesmo se for array vazio)
          dadosDisciplinasPorSimulado[gabaritoId] = disciplinas;
          
          if (disciplinas.length === 0) {
            const gabaritoNome = data.gabarito?.nome || 'este simulado';
            const gabaritoEtapa = data.gabarito?.etapa || '';
            showToast(`Este aluno n√£o possui respostas v√°lidas para o simulado "${gabaritoNome}${gabaritoEtapa ? ' - ' + gabaritoEtapa : ''}" ou n√£o h√° disciplinas com dados.`, 'info');
            // Mostrar gr√°fico vazio
            atualizarGraficoDisciplinas([]);
          } else {
            atualizarGraficoDisciplinas(disciplinas);
          }
        } else {
          showToast(data.erro || 'Erro ao carregar dados do desempenho por disciplina', 'error');
          event.target.value = 'geral'; // Resetar para geral
          atualizarGraficoDisciplinas(dadosDisciplinasGerais);
        }
      } catch (error) {
        console.error('Erro ao filtrar disciplinas:', error);
        
        // Verificar tipo de erro
        let mensagemErro = 'Erro ao filtrar disciplinas. Tente novamente.';
        
        if (error.name === 'TypeError' && (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_REFUSED') || error.message.includes('ERR_CONNECTION_RESET'))) {
          mensagemErro = 'Erro de conex√£o com o servidor. Verifique se o servidor est√° rodando na porta 3000.';
        } else if (error.message) {
          mensagemErro = error.message;
        }
        
        showToast(mensagemErro, 'error');
        
        // Resetar para geral em caso de erro
        try {
          event.target.value = 'geral';
          atualizarGraficoDisciplinas(dadosDisciplinasGerais);
        } catch (resetError) {
          console.error('Erro ao resetar para geral:', resetError);
        }
      } finally {
        hideLoading();
      }
    }

    function atualizarTabelaSimulados(simulados) {
      const corpoTabela = document.getElementById('corpoTabelaSimulados');
      const mensagemSemSimulados = document.getElementById('mensagemSemSimulados');
      const container = document.getElementById('containerRelatorioSimulados');
      
      let dados = Array.isArray(simulados) ? simulados : [];
      
      if (dados.length === 0) {
        corpoTabela.innerHTML = '';
        mensagemSemSimulados.style.display = 'block';
        if (container) container.style.display = 'none';
        return;
      }
      
      mensagemSemSimulados.style.display = 'none';
      if (container) container.style.display = 'block';
      
      // Ordenar por data (mais recente primeiro)
      dados = [...dados].sort((a, b) => {
        const dataA = a.data ? new Date(a.data) : new Date(0);
        const dataB = b.data ? new Date(b.data) : new Date(0);
        return dataB - dataA;
      });
      
      corpoTabela.innerHTML = dados.map((simulado, index) => {
        const nome = simulado.nome || 'Simulado sem nome';
        const etapa = simulado.etapa || 'N/A';
        const gabaritoId = simulado.id;
        const totalQuestoes = Number(simulado.total_questoes || 0);
        const questoesCapturadas = Number(simulado.questoes_capturadas || 0);
        const acertos = Number(simulado.acertos || 0);
        const media = Number(simulado.media || 0);
        const dataFormatada = simulado.data 
          ? new Date(simulado.data).toLocaleDateString('pt-BR', { 
              day: '2-digit', 
              month: '2-digit', 
              year: 'numeric' 
            })
          : 'N/A';
        
        // Cor da linha baseada na m√©dia
        let corFundo = 'transparent';
        let corTexto = '#003b54';
        if (media >= 70) {
          corFundo = 'rgba(46, 204, 113, 0.1)';
        } else if (media >= 50) {
          corFundo = 'rgba(241, 196, 15, 0.1)';
        } else {
          corFundo = 'rgba(231, 76, 60, 0.1)';
        }
        
        // Cor da m√©dia
        let corMedia = '#003b54';
        if (media >= 70) {
          corMedia = '#2ecc71';
        } else if (media >= 50) {
          corMedia = '#f1c40f';
        } else {
          corMedia = '#e74c3c';
        }
        
        // Cor para quest√µes capturadas (verde se todas foram capturadas, amarelo se parcial, vermelho se poucas)
        let corQuestoesCapturadas = '#666';
        if (totalQuestoes > 0) {
          const percentualCapturado = (questoesCapturadas / totalQuestoes) * 100;
          if (percentualCapturado >= 90) {
            corQuestoesCapturadas = '#2ecc71';
          } else if (percentualCapturado >= 50) {
            corQuestoesCapturadas = '#f1c40f';
          } else {
            corQuestoesCapturadas = '#e74c3c';
          }
        }
        
        return `
          <tr id="simulado-row-${gabaritoId}" style="background: ${corFundo}; transition: background 0.2s;" 
              onmouseover="this.style.background='rgba(0, 140, 196, 0.1)'" 
              onmouseout="this.style.background='${corFundo}'">
            <td style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: ${corTexto}; cursor: pointer; position: relative;" 
                onclick="toggleDetalhesSimulado('${gabaritoId}', '${alunoSelecionado ? alunoSelecionado.id : ''}')"
                title="Clique para ver detalhes do gabarito">
              <span id="icon-${gabaritoId}" style="display: inline-block; margin-right: 8px; transition: transform 0.3s;">‚ñ∂</span>
              <span style="display: inline-block;">${nome}</span>
            </td>
            <td style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; text-align: center; color: #666;">
              ${etapa}
            </td>
            <td style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; text-align: center; color: #666;">
              ${totalQuestoes.toLocaleString('pt-BR')}
            </td>
            <td style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; text-align: center; color: ${corQuestoesCapturadas}; font-weight: 600;">
              ${questoesCapturadas.toLocaleString('pt-BR')}
            </td>
            <td style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; text-align: center; color: #666; font-weight: 600;">
              ${acertos.toLocaleString('pt-BR')}
            </td>
            <td style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; text-align: center; font-weight: 700; color: ${corMedia}; font-size: 15px;">
              ${media.toFixed(1)}%
            </td>
            <td style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; text-align: center; color: #666;">
              ${dataFormatada}
            </td>
          </tr>
          <tr id="detalhes-${gabaritoId}" style="display: none;">
            <td colspan="7" style="padding: 0; border-bottom: 1px solid #e0e0e0; background: #f8f9fa;">
              <div id="conteudo-detalhes-${gabaritoId}" style="padding: 20px;">
                <div style="text-align: center; color: #666;">
                  <div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0,140,196,.3); border-radius: 50%; border-top-color: #008cc4; animation: spin 1s ease-in-out infinite;"></div>
                  <span style="margin-left: 10px;">Carregando detalhes...</span>
                </div>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function atualizarGraficoDisciplinas(disciplinas) {
      const canvas = document.getElementById('graficoDisciplinas');
      if (!canvas) {
        console.error('Canvas graficoDisciplinas n√£o encontrado');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      let dados = Array.isArray(disciplinas) ? disciplinas : [];
      
      // Configurar alta resolu√ß√£o para telas Retina
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      
      // Ajustar tamanho do canvas para alta resolu√ß√£o
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      
      // Ajustar estilo do canvas para manter tamanho visual
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      
      // Se n√£o houver dados, mostrar gr√°fico vazio com mensagem
      if (dados.length === 0) {
        if (graficoDisciplinas) {
          graficoDisciplinas.destroy();
        }
        
        // Reconfigurar canvas antes de criar novo gr√°fico
        const dprEmpty = window.devicePixelRatio || 1;
        const rectEmpty = canvas.getBoundingClientRect();
        canvas.width = rectEmpty.width * dprEmpty;
        canvas.height = rectEmpty.height * dprEmpty;
        ctx.scale(dprEmpty, dprEmpty);
        canvas.style.width = rectEmpty.width + 'px';
        canvas.style.height = rectEmpty.height + 'px';
        
        // Obter cores das vari√°veis CSS
        const rootEmpty = getComputedStyle(document.documentElement);
        const colorBorderLightEmpty = rootEmpty.getPropertyValue('--color-border-light').trim() || '#e0e0e0';
        const colorBorderEmpty = rootEmpty.getPropertyValue('--color-border').trim() || '#cccccc';
        
        graficoDisciplinas = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Sem dados'],
            datasets: [{
              label: 'Quest√µes',
              data: [0],
              backgroundColor: colorBorderLightEmpty,
              borderColor: colorBorderEmpty,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            devicePixelRatio: window.devicePixelRatio || 2,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
        return;
      }
      
      // Ordenar por m√©dia de acertos (maior para menor) para melhor visualiza√ß√£o
      // O backend j√° calcula a m√©dia corretamente, ent√£o usamos o valor 'media' diretamente
      dados = [...dados].sort((a, b) => {
        const mediaA = Number(a.media || 0);
        const mediaB = Number(b.media || 0);
        return mediaB - mediaA;
      });

      const labels = dados.map(d => {
        const nome = d.nome || 'Disciplina';
        // N√£o encurtar nomes, deixar completos para melhor legibilidade
        return nome;
      });

      // Usar a m√©dia que j√° vem calculada do backend (j√° est√° em percentual 0-100)
      const medias = dados.map(d => Number(d.media || 0));

      if (graficoDisciplinas) {
        graficoDisciplinas.destroy();
      }

      // Obter cores das vari√°veis CSS para Chart.js
      const rootDisciplinas = getComputedStyle(document.documentElement);
      const colorPrimaryDisciplinas = rootDisciplinas.getPropertyValue('--color-primary').trim() || '#008cc4';
      const colorPrimaryDarkerDisciplinas = rootDisciplinas.getPropertyValue('--color-primary-darker').trim() || '#003b54';
      const colorTextLightDisciplinas = rootDisciplinas.getPropertyValue('--color-text-light').trim() || '#666666';
      const colorTextDisciplinas = rootDisciplinas.getPropertyValue('--color-text').trim() || '#333333';
      const colorBorderLightDisciplinas = rootDisciplinas.getPropertyValue('--color-border-light').trim() || '#e0e0e0';

      // Reconfigurar canvas antes de criar novo gr√°fico (garantir alta resolu√ß√£o)
      const dprChart = window.devicePixelRatio || 1;
      const rectChart = canvas.getBoundingClientRect();
      canvas.width = rectChart.width * dprChart;
      canvas.height = rectChart.height * dprChart;
      ctx.scale(dprChart, dprChart);
      canvas.style.width = rectChart.width + 'px';
      canvas.style.height = rectChart.height + 'px';

      graficoDisciplinas = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels.length > 0 ? labels : ['Sem dados'],
          datasets: [{
            label: 'Taxa de Acertos (%)',
            data: medias.length > 0 ? medias : [0],
            backgroundColor: colorPrimaryDisciplinas,
            borderRadius: 8,
            barThickness: 28,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          devicePixelRatio: window.devicePixelRatio || 2,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: colorPrimaryDarkerDisciplinas,
              padding: 12,
              titleFont: {
                size: 14,
                weight: '600'
              },
              bodyFont: {
                size: 13
              },
              cornerRadius: 8,
              callbacks: {
                label: context => {
                  const disciplina = dados[context.dataIndex];
                  const totalQuestoes = disciplina ? Number(disciplina.total_questoes || 0) : 0;
                  const acertos = disciplina ? Number(disciplina.acertos || 0) : 0;
                  // Mostrar total de quest√µes da disciplina (n√£o apenas as respondidas v√°lidamente)
                  // Isso reflete corretamente o c√°lculo da m√©dia na barra
                  return `Taxa de acertos: ${context.raw.toFixed(1)}% (${acertos.toLocaleString('pt-BR')} de ${totalQuestoes.toLocaleString('pt-BR')} quest√µes)`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: value => `${value}%`,
                font: {
                  size: 12
                },
                color: colorTextLightDisciplinas
              },
              grid: {
                color: colorBorderLightDisciplinas
              }
            },
            y: {
              ticks: {
                font: { size: 13, weight: '500' },
                color: colorTextDisciplinas
              },
              grid: { display: false }
            }
          }
        }
      });
    }

    // Fechar sugest√µes ao clicar fora
    document.addEventListener('click', function(event) {
      const sugestoesDiv = document.getElementById('sugestoesAlunos');
      const buscaInput = document.getElementById('buscaAluno');
      const buscaContainer = buscaInput ? buscaInput.closest('.input-group') : null;
      
      if (buscaContainer && !buscaContainer.contains(event.target)) {
        sugestoesDiv.style.display = 'none';
      }
    });

    // Limpar sele√ß√£o quando o campo for limpo
    document.getElementById('buscaAluno').addEventListener('input', function(e) {
      if (e.target.value.trim() === '') {
        alunoSelecionado = null;
        document.getElementById('infoAlunoSelecionado').style.display = 'none';
      }
    });

    async function toggleDetalhesSimulado(gabaritoId, alunoId) {
      const detalhesRow = document.getElementById(`detalhes-${gabaritoId}`);
      const icon = document.getElementById(`icon-${gabaritoId}`);
      const conteudoDiv = document.getElementById(`conteudo-detalhes-${gabaritoId}`);
      
      if (!detalhesRow) return;
      
      // Se alunoId n√£o foi fornecido, tentar pegar de alunoSelecionado
      if (!alunoId && alunoSelecionado && alunoSelecionado.id) {
        alunoId = alunoSelecionado.id;
      }
      
      if (!alunoId) {
        showToast('Erro: Aluno n√£o selecionado', 'error');
        return;
      }

      // Alternar visibilidade
      const isVisible = detalhesRow.style.display !== 'none';
      
      if (isVisible) {
        // Fechar
        detalhesRow.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
        icon.textContent = '‚ñ∂';
      } else {
        // Abrir
        detalhesRow.style.display = 'table-row';
        icon.style.transform = 'rotate(90deg)';
        icon.textContent = '‚ñº';
        
        // Se ainda n√£o carregou os dados, carregar agora
        if (conteudoDiv.innerHTML.includes('Carregando detalhes')) {
          await carregarDetalhesSimulado(gabaritoId, alunoId);
        }
      }
    }

    async function carregarDetalhesSimulado(gabaritoId, alunoId) {
      const conteudoDiv = document.getElementById(`conteudo-detalhes-${gabaritoId}`);
      const token = localStorage.getItem('token');
      
      if (!token) {
        conteudoDiv.innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">Erro: Token n√£o encontrado</div>';
        return;
      }

      try {
        // Buscar quest√µes do gabarito e respostas do aluno em paralelo
        const [questoesRes, respostasRes] = await Promise.all([
          fetch(`/api/questoes/gabarito/${gabaritoId}`, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          }),
          fetch(`/api/respostas?aluno_id=${alunoId}&gabarito_id=${gabaritoId}`, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          })
        ]);

        if (!questoesRes.ok || !respostasRes.ok) {
          throw new Error('Erro ao carregar dados');
        }

        const questoesData = await questoesRes.json();
        const respostasData = await respostasRes.json();

        const questoes = questoesData.questoes || [];
        const respostas = respostasData.respostas || [];

        // Criar mapa de respostas por quest√£o_id
        const mapaRespostas = {};
        respostas.forEach(resposta => {
          if (resposta.resposta_aluno && 
              resposta.resposta_aluno.trim() !== '' && 
              !resposta.resposta_aluno.includes(',')) {
            mapaRespostas[resposta.questao_id] = resposta.resposta_aluno.trim().toUpperCase();
          }
        });

        // Ordenar quest√µes por n√∫mero
        const questoesOrdenadas = [...questoes].sort((a, b) => Number(a.numero) - Number(b.numero));

        // Gerar HTML da tabela de detalhes
        let html = `
          <div style="background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h4 style="margin: 0 0 16px 0; color: #003b54; font-size: 16px; font-weight: 600;">
              Detalhes do Gabarito
            </h4>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                  <tr style="background: #f0f7fa; border-bottom: 2px solid #008cc4;">
                    <th style="padding: 10px 12px; text-align: center; font-weight: 600; color: #003b54; width: 80px;">Quest√£o</th>
                    <th style="padding: 10px 12px; text-align: center; font-weight: 600; color: #003b54; width: 120px;">Gabarito</th>
                    <th style="padding: 10px 12px; text-align: center; font-weight: 600; color: #003b54; width: 120px;">Capturada</th>
                    <th style="padding: 10px 12px; text-align: center; font-weight: 600; color: #003b54;">Status</th>
                  </tr>
                </thead>
                <tbody>
        `;

        questoesOrdenadas.forEach(questao => {
          const numero = questao.numero;
          const gabarito = (questao.resposta_correta || '').trim().toUpperCase();
          const capturada = mapaRespostas[questao.id] || '-';
          const acertou = capturada !== '-' && capturada === gabarito;
          
          let statusHtml = '';
          let statusColor = '#666';
          
          if (capturada === '-') {
            statusHtml = '<span style="color: #666;">N√£o respondida</span>';
          } else if (acertou) {
            statusHtml = '<span style="color: #2ecc71; font-weight: 600;">‚úì Acertou</span>';
            statusColor = '#2ecc71';
          } else {
            statusHtml = '<span style="color: #e74c3c; font-weight: 600;">‚úó Errou</span>';
            statusColor = '#e74c3c';
          }

          html += `
            <tr style="border-bottom: 1px solid #e0e0e0;">
              <td style="padding: 10px 12px; text-align: center; font-weight: 600; color: #003b54;">${numero}</td>
              <td style="padding: 10px 12px; text-align: center; font-weight: 600; color: #008cc4; font-size: 14px;">${gabarito || '-'}</td>
              <td style="padding: 10px 12px; text-align: center; font-weight: 600; color: ${statusColor}; font-size: 14px;">${capturada}</td>
              <td style="padding: 10px 12px; text-align: center;">${statusHtml}</td>
            </tr>
          `;
        });

        html += `
                </tbody>
              </table>
            </div>
          </div>
        `;

        conteudoDiv.innerHTML = html;

      } catch (error) {
        console.error('Erro ao carregar detalhes:', error);
        conteudoDiv.innerHTML = `
          <div style="color: #e74c3c; text-align: center; padding: 20px;">
            Erro ao carregar detalhes do simulado. Tente novamente.
          </div>
        `;
      }
    }

    // Adicionar anima√ß√£o de spin para o spinner
    const style = document.createElement('style');
    style.textContent = `
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>

