<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agendar Sessão - EduScore</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="utils.js" defer></script>
</head>
<body>
  <!-- Skip Links para navegação por teclado -->
  <a href="#main-content" class="skip-link">Pular para conteúdo principal</a>
  <a href="#main-navigation" class="skip-link">Pular para navegação principal</a>
  
  <div class="home-container">
    <aside class="sidebar">
      <div class="profile" id="sidebar-profile">
        <img src="https://img.icons8.com/ios-filled/100/ffffff/user-male-circle.png" alt="Perfil" />
        <span style="opacity: 0;"><!-- Carregando... --></span>
      </div>
      <nav class="nav-links" role="navigation" aria-label="Menu principal" id="main-navigation">
        <a href="home.html"><img src="https://img.icons8.com/ios-filled/24/ffffff/home-page.png" alt="" /> Home</a>
        <a href="GerarRelatorio.html"><img src="https://img.icons8.com/ios-filled/24/ffffff/report-card.png" alt="" /> Gerar Relatório</a>
        <a href="Cadastrar.html"><img src="https://img.icons8.com/ios-filled/24/ffffff/add-user-male.png" alt="" /> Cadastrar</a>
        <a href="CadastrarGabarito.html"><img src="https://img.icons8.com/ios-filled/24/ffffff/test-passed.png" alt="" /> Simulado</a>
        <a href="AgendarSessao.html" class="active" aria-current="page"><img src="https://img.icons8.com/ios-filled/24/ffffff/calendar.png" alt="" /> Agendar Sessão</a>
      </nav>
    </aside>

    <main class="content" id="main-content" role="main">
      <!-- Breadcrumb e User Profile -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xl);">
        <nav class="breadcrumb" aria-label="Breadcrumb" style="margin: 0;">
          <a href="home.html">Home</a>
          <span class="breadcrumb-separator">/</span>
          <span>Agendar Sessão</span>
        </nav>
        <div class="user-profile-menu">
          <button class="user-avatar-button" id="user-menu-button" aria-label="Abrir menu do usuário">CO</button>
          <div class="dropdown-menu hidden" id="user-dropdown">
            <div class="dropdown-header">
              <p class="user-name">Coordenador</p>
              <p class="user-email">coordenacao@uea.edu.br</p>
              <p class="user-score"><strong>Coordenador</strong></p>
            </div>
            <ul>
              <li><a href="meuperfil.html"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> Meu Perfil</a></li>
              <li><a href="configuracoes.html"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-4.44a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.88z"></path><path d="M18 2h-2.17a2 2 0 0 0-1.41.59L12 5l-2.41-2.41A2 2 0 0 0 8.17 2H6"></path><path d="M9.5 2a2.83 2.83 0 0 1 5 0"></path></svg> Configurações</a></li>
              <li><a href="#" onclick="logout()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg> Sair</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Header -->
      <div class="dashboard-header">
        <div>
          <h2>Agendar Sessão</h2>
          <p class="dashboard-subtitle">Gerencie as sessões de avaliação dos alunos</p>
        </div>
      </div>

      <!-- Botão Adicionar -->
      <div style="margin-top: var(--spacing-xl); margin-bottom: var(--spacing-lg);">
        <button 
          class="btn-primary" 
          onclick="abrirFormulario()" 
          aria-label="Abrir formulário para adicionar nova sessão"
          style="display: block; margin: 0 auto;"
        >
          + Adicionar Sessão
        </button>
      </div>

      <!-- Modal de Formulário em Card -->
      <div class="card" id="modalAgendar" style="max-width: 600px; margin: 0 auto var(--spacing-xl); display: none;">
        <div class="card-header">
          <h3 class="card-title" id="modalTitle">Nova Sessão</h3>
        </div>
        <div style="padding: var(--spacing-xl);">
          <form id="formSessao" style="display: flex; flex-direction: column; gap: var(--spacing-lg);">
            <div class="input-group">
              <label for="alunoNome">
                Nome do Aluno 
                <span class="required-field"></span>
              </label>
              <select 
                id="alunoNome" 
                required
                aria-label="Selecione o aluno"
                aria-required="true"
                style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: var(--font-size-base); outline: none; transition: border-color var(--transition-base); background: var(--color-surface);"
              >
                <option value="">Selecione o aluno</option>
              </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
              <div class="input-group">
                <label for="etapa">
                  Etapa 
                  <span class="required-field"></span>
                </label>
                <select 
                  id="etapa" 
                  required
                  aria-label="Selecione a etapa"
                  aria-required="true"
                  style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: var(--font-size-base); outline: none; transition: border-color var(--transition-base); background: var(--color-surface);"
                >
                  <option value="">Selecione</option>
                  <option value="1º Ano">1º Ano</option>
                  <option value="2º Ano">2º Ano</option>
                  <option value="3º Ano">3º Ano</option>
                </select>
              </div>

              <div class="input-group">
                <label for="materia">
                  Disciplina 
                  <span class="required-field"></span>
                </label>
                <select 
                  id="materia" 
                  required
                  aria-label="Selecione a disciplina"
                  aria-required="true"
                  style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: var(--font-size-base); outline: none; transition: border-color var(--transition-base); background: var(--color-surface);"
                >
                  <option value="">Selecione a disciplina</option>
                </select>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
              <div class="input-group">
                <label for="dataSessao">
                  Data 
                  <span class="required-field"></span>
                </label>
                <input 
                  type="date" 
                  id="dataSessao" 
                  required
                  aria-label="Data da sessão"
                  aria-required="true"
                  style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: var(--font-size-base); outline: none; transition: border-color var(--transition-base);"
                />
              </div>

              <div class="input-group">
                <label for="horaSessao">
                  Horário 
                  <span class="required-field"></span>
                </label>
                <input 
                  type="time" 
                  id="horaSessao" 
                  required
                  aria-label="Horário da sessão"
                  aria-required="true"
                  style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: var(--font-size-base); outline: none; transition: border-color var(--transition-base);"
                />
              </div>
            </div>

            <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md);">
              <button 
                type="button" 
                class="btn-secondary" 
                onclick="fecharFormulario()" 
                aria-label="Cancelar e fechar formulário"
                style="flex: 1;"
              >
                Cancelar
              </button>
              <button 
                type="button" 
                class="btn-primary" 
                onclick="confirmarAgendamento()" 
                aria-label="Confirmar e salvar agendamento"
                style="flex: 1;"
              >
                Agendar
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Lista de Sessões -->
      <div class="card" style="margin-top: var(--spacing-xl);">
        <div class="card-header">
          <h3 class="card-title">Sessões Agendadas</h3>
        </div>
        <div style="padding: var(--spacing-lg);">
          <div class="session-list" id="sessionList">
            <!-- Sessões adicionadas aparecerão aqui -->
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
    let sessaoEditandoId = null;
    let alunos = [];
    let disciplinas = [];
    let usuarioAtual = null;

    // Carregar dados ao inicializar
    document.addEventListener('DOMContentLoaded', async () => {
      await loadUserData();
      await carregarAlunos();
      await carregarDisciplinas();
      await carregarSessoes();
    });

    async function loadUserData() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      try {
        const response = await apiFetch('/api/usuarios/me', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        if (data.sucesso) {
          usuarioAtual = data.usuario;
        }
      } catch (error) {
        console.error('Erro ao carregar dados do usuário:', error);
      }
    }

    async function carregarAlunos() {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        showLoading('Carregando alunos...');
        const response = await apiFetch('/api/alunos', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        if (data.sucesso || Array.isArray(data)) {
          alunos = data.alunos || data;
          atualizarSelectAlunos();
        }
      } catch (error) {
        console.error('Erro ao carregar alunos:', error);
        showToast('Erro ao carregar lista de alunos', 'error');
      } finally {
        hideLoading();
      }
    }

    async function carregarDisciplinas() {
      try {
        showLoading('Carregando disciplinas...');
        const response = await apiFetch('/api/disciplinas');
        const data = await response.json();
        if (data.sucesso || Array.isArray(data)) {
          disciplinas = data.disciplinas || data;
          atualizarSelectDisciplinas();
        }
      } catch (error) {
        console.error('Erro ao carregar disciplinas:', error);
        showToast('Erro ao carregar lista de disciplinas', 'error');
      } finally {
        hideLoading();
      }
    }

    function atualizarSelectAlunos() {
      const select = document.getElementById('alunoNome');
      if (!select) return;
      
      select.innerHTML = '<option value="">Selecione o aluno</option>';
      alunos.forEach(aluno => {
        const option = document.createElement('option');
        option.value = aluno.id;
        option.textContent = aluno.nome_completo;
        select.appendChild(option);
      });
    }

    function atualizarSelectDisciplinas() {
      const select = document.getElementById('materia');
      if (!select) return;
      
      select.innerHTML = '<option value="">Selecione a disciplina</option>';
      disciplinas.forEach(disciplina => {
        const option = document.createElement('option');
        option.value = disciplina.id;
        option.textContent = disciplina.nome;
        select.appendChild(option);
      });
    }

    async function carregarSessoes() {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        showLoading('Carregando sessões...');
        const response = await apiFetch('/api/sessoes', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        if (data.sucesso || Array.isArray(data)) {
          renderizarSessoes(data.sessoes || data);
        }
      } catch (error) {
        console.error('Erro ao carregar sessões:', error);
        showToast('Erro ao carregar sessões agendadas', 'error');
      } finally {
        hideLoading();
      }
    }

    function renderizarSessoes(sessoes) {
      const container = document.getElementById('sessionList');
      if (!container) return;
      
      container.innerHTML = '';
      if (!sessoes || sessoes.length === 0) {
        container.innerHTML = '<div class="empty-state"><p style="color: var(--color-text-light);">Nenhuma sessão agendada</p></div>';
        return;
      }

      sessoes.forEach(sessao => {
        const div = document.createElement('div');
        div.className = 'session-item';
        div.dataset.sessaoId = sessao.id;
        const dataFormatada = sessao.data ? sessao.data.split('-').reverse().slice(0, 2).join('/') : '';
        div.innerHTML = `
          <span style="flex: 1;"><strong>${sessao.aluno_nome || 'Aluno'}</strong> | ${sessao.etapa} | ${dataFormatada} | ${sessao.hora} | ${sessao.disciplina_nome || 'Disciplina'}</span>
          <div class="actions" style="display: flex; gap: var(--spacing-sm);">
            <button 
              class="btn-secondary" 
              onclick="editarSessao('${sessao.id}')" 
              aria-label="Editar sessão de ${sessao.aluno_nome || 'aluno'}"
              style="padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-sm);"
            >
              Editar
            </button>
            <button 
              class="btn-secondary" 
              onclick="excluirSessao('${sessao.id}')" 
              aria-label="Excluir sessão de ${sessao.aluno_nome || 'aluno'}"
              style="padding: var(--spacing-sm) var(--spacing-md); font-size: var(--font-size-sm); background: var(--color-error); color: white;"
            >
              Excluir
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function abrirFormulario() {
      document.getElementById('alunoNome').value = '';
      document.getElementById('etapa').value = '';
      document.getElementById('materia').value = '';
      document.getElementById('dataSessao').value = '';
      document.getElementById('horaSessao').value = '';
      document.getElementById('modalAgendar').style.display = 'block';
      document.getElementById('modalTitle').textContent = 'Nova Sessão';
      sessaoEditandoId = null;
    }

    async function editarSessao(sessaoId) {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        const response = await apiFetch(`/api/sessoes/${sessaoId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        if (data.sucesso && data.sessao) {
          const s = data.sessao;
          document.getElementById('alunoNome').value = s.aluno_id || '';
          document.getElementById('etapa').value = s.etapa || '';
          document.getElementById('materia').value = s.disciplina_id || '';
          document.getElementById('dataSessao').value = s.data || '';
          document.getElementById('horaSessao').value = s.hora || '';
          document.getElementById('modalAgendar').style.display = 'block';
          document.getElementById('modalTitle').textContent = 'Editar Sessão';
          sessaoEditandoId = sessaoId;
        }
      } catch (error) {
        console.error('Erro ao carregar sessão:', error);
        showToast('Erro ao carregar sessão', 'error');
      }
  }

  function fecharFormulario() {
    document.getElementById('modalAgendar').style.display = 'none';
      document.getElementById('alunoNome').value = '';
      document.getElementById('etapa').value = '';
      document.getElementById('materia').value = '';
      document.getElementById('dataSessao').value = '';
      document.getElementById('horaSessao').value = '';
      sessaoEditandoId = null;
    }

    async function confirmarAgendamento() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const alunoId = document.getElementById('alunoNome').value;
    const etapa = document.getElementById('etapa').value;
      const disciplinaId = document.getElementById('materia').value;
    const data = document.getElementById('dataSessao').value;
    const hora = document.getElementById('horaSessao').value;

      if (!alunoId || !etapa || !disciplinaId || !data || !hora) {
        showToast('Preencha todos os campos obrigatórios', 'warning');
      return;
    }

      try {
        showLoading('Salvando sessão...');
        
        const usuarioId = usuarioAtual?.id || JSON.parse(atob(token.split('.')[1])).userId;
        
        const url = sessaoEditandoId ? `/api/sessoes/${sessaoEditandoId}` : '/api/sessoes';
        const method = sessaoEditandoId ? 'PUT' : 'POST';
        
        const response = await apiFetch(url, {
          method,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            aluno_id: alunoId,
            etapa,
            disciplina_id: disciplinaId,
            data,
            hora,
            usuario_id: usuarioId
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.erro || 'Erro ao salvar sessão');
        }

        showToast('Sessão agendada com sucesso!', 'success');
    fecharFormulario();
        await carregarSessoes();

      } catch (error) {
        console.error('Erro ao salvar sessão:', error);
        showToast(`Erro ao salvar sessão: ${error.message}`, 'error');
      } finally {
        hideLoading();
      }
    }

    async function excluirSessao(sessaoId) {
      const token = localStorage.getItem('token');
      if (!token) return;

      showConfirmDialog(
        'Deseja realmente excluir esta sessão?',
        async () => {
          try {
            showLoading('Excluindo sessão...');
            const response = await apiFetch(`/api/sessoes/${sessaoId}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.erro || 'Erro ao excluir sessão');
            }

            showToast('Sessão excluída com sucesso', 'success');
            await carregarSessoes();

          } catch (error) {
            console.error('Erro ao excluir sessão:', error);
            showToast(`Erro ao excluir sessão: ${error.message}`, 'error');
          } finally {
            hideLoading();
          }
        }
      );
  }
</script>
</body>
</html>
